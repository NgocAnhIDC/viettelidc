<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI TT Cloud - Quản lý Công việc</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.12.8/reset.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="assets/css/common.css" rel="stylesheet">
    <!-- SheetJS for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Authentication System -->
    <script src="assets/js/auth.js"></script>
    <style>
        /* Task Management Specific Styles */

        /* Submenu Styles */
        .has-submenu {
            position: relative;
            cursor: pointer;
        }

        .submenu-arrow {
            position: absolute;
            right: 20px;
            transition: transform 0.3s ease;
        }

        .submenu {
            display: none;
            background: transparent;
            margin-left: 0;
            padding-left: 0;
        }

        .submenu-item {
            display: flex;
            align-items: center;
            padding: 10px 20px 10px 40px;
            color: #999;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 14px;
            border-left: 3px solid transparent;
        }

        .submenu-item:hover {
            background: #2a2a2a;
            color: #fff;
            border-left-color: #555;
        }

        .submenu-item.active {
            background: #2a2a2a;
            color: #00ff88;
            border-left-color: #00ff88;
        }

        .submenu-item-icon {
            width: 16px;
            text-align: center;
            margin-right: 12px;
            font-size: 12px;
        }

        .sidebar.collapsed .submenu {
            display: none !important;
        }

        .sidebar.collapsed .submenu-arrow {
            display: none;
        }

        /* Task Management Specific Styles */
        .task-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .search-filters {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }

        .search-box:focus {
            outline: none;
            border-color: #00ff88;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }



        /* Dynamic column visibility */
        .table .col-hidden {
            display: none;
        }

        /* Row selection styles */
        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 255, 136, 0.1) !important;
        }

        .table tbody tr[data-selected="true"] {
            background-color: rgba(0, 255, 136, 0.15) !important;
        }

        .table tbody tr[data-selected="true"]:hover {
            background-color: rgba(0, 255, 136, 0.2) !important;
        }

        /* Checkbox styling */
        .table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #00ff88;
            cursor: pointer;
        }

        /* Indeterminate checkbox styling */
        .table input[type="checkbox"]:indeterminate {
            background-color: #00ff88;
            border-color: #00ff88;
        }

        /* Import Wizard Styles */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #ddd;
            z-index: 1;
        }

        .step.active:not(:last-child)::after {
            background: #00458b;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }

        .step.active .step-number {
            background: #00458b;
            color: white;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-title {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .step.active .step-title {
            color: #00458b;
            font-weight: bold;
        }

        .wizard-step {
            display: none;
            min-height: 400px;
        }

        .wizard-step.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: #00458b;
            background: rgba(0, 69, 139, 0.05);
        }

        .upload-area.dragover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .wizard-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .preview-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .preview-table {
            max-height: 300px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 12px;
            color: #333;
            background: white;
        }

        .preview-table th {
            background: #f8f9fa !important;
            color: #333 !important;
            font-weight: bold;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #dee2e6;
        }

        .preview-table tr.error-row {
            background: #fff5f5 !important;
        }

        .preview-table tr.error-row td {
            background: #fff5f5 !important;
            color: #721c24 !important;
        }

        .preview-table tr.valid-row {
            background: white !important;
        }

        .preview-table tr.valid-row td {
            background: white !important;
            color: #333 !important;
        }

        .preview-table tr:hover {
            background: #f8f9fa !important;
        }

        .preview-table tr:hover td {
            background: #f8f9fa !important;
        }

        .error-summary {
            background: #fff8e1;
            border: 1px solid #ffcc02;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #333;
        }

        .error-summary h4 {
            color: #e65100;
            margin-bottom: 15px;
        }

        .error-summary p {
            color: #333;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .success-summary {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #333;
        }

        .success-summary h4 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .instruction-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            color: #333;
        }

        .instruction-box h5 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .instruction-box ol {
            margin: 10px 0;
            padding-left: 20px;
            color: #333;
        }

        .instruction-box li {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .delay-warning {
            color: #ff6b35;
            font-size: 14px;
            margin-left: 8px;
            cursor: help;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Form Sections & Collapsible UI */
        .form-section {
            margin-bottom: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            overflow: hidden;
            background: #2a2a2a;
        }

        .form-section-header {
            background: #333;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
            transition: background-color 0.2s ease;
        }

        .form-section-header:hover {
            background: #404040;
        }

        .form-section-header.collapsed {
            border-bottom: none;
        }

        .form-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #fff;
            font-size: 14px;
        }

        .form-section-icon {
            font-size: 16px;
            color: #fff;
            font-weight: 400;
        }

        .form-section-toggle {
            font-size: 12px;
            color: #ccc;
            transition: transform 0.2s ease;
        }

        .form-section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .form-section-content {
            padding: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
            background: #2a2a2a;
        }

        .form-section-content.collapsed {
            max-height: 0;
            padding: 0 20px;
            opacity: 0;
        }

        .form-section-content.expanded {
            max-height: 1000px;
            opacity: 1;
        }

        .form-section-description {
            font-size: 12px;
            color: #999;
            margin-left: 24px;
        }

        .form-progress {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #00458b;
        }

        .form-progress-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }

        .form-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00458b, #3fd2c7);
            transition: width 0.3s ease;
        }

        .form-progress-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }



        .error-details {
            max-height: 300px;
            overflow: auto;
        }

        .error-item {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border-left: 4px solid #e53e3e;
        }

        .error-item .error-row {
            font-weight: bold;
            color: #c53030;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .error-item .error-message {
            color: #2d3748;
            margin-top: 5px;
            line-height: 1.4;
        }

        .error-item .error-message ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .error-item .error-message li {
            margin-bottom: 3px;
            color: #4a5568;
        }

        .import-summary {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #00458b;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .stat-item.success .stat-number {
            color: #28a745;
        }

        .stat-item.error .stat-number {
            color: #dc3545;
        }

        .stat-item.info .stat-number {
            color: #17a2b8;
        }

        /* Quick filter button */
        .btn-quick {
            background: transparent;
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-quick:hover {
            background: #00ff88;
            color: #1a1a1a;
        }

        .btn-quick.active {
            background: #00ff88;
            color: #1a1a1a;
        }

        /* Override status badges - outline style */
        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: transparent !important;
            border: 1px solid;
            display: inline-block;
            text-align: center;
            min-width: 80px;
            white-space: nowrap;
        }

        .status-not-started {
            border-color: #666;
            color: #666;
        }

        .status-in-progress {
            border-color: #ccc;
            color: #ccc;
        }

        .status-completed {
            border-color: #00ff88;
            color: #00ff88;
        }

        .status-pending-approval {
            border-color: #ff9500;
            color: #ff9500;
        }

        /* Action buttons - outline style */
        .btn-action {
            background: transparent !important;
            border: 1px solid #555;
            color: #ccc;
            padding: 6px 8px;
            font-size: 12px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px;
        }

        .btn-action:hover {
            border-color: #00ff88;
            color: #00ff88;
            background: transparent !important;
        }

        /* Table header separation */
        .table-header-section {
            background: #312F30;
            padding: 20px 30px;
            border-bottom: 1px solid #00ff88;
        }

        .table-content-section {
            background: #454647;
        }

        /* Table cell alignment */
        .table .text-center {
            text-align: center;
        }

        .table .actions-cell {
            text-align: center;
            white-space: nowrap;
            width: 120px;
        }

        /* Table headers center alignment */
        .table th {
            text-align: center;
            vertical-align: middle;
            line-height: 1.2;
        }

        /* Table data cell alignment - center for most columns */
        .table td {
            text-align: center;
            vertical-align: middle;
        }

        /* Left align for text-heavy columns */
        .table .text-left {
            text-align: left;
        }

        /* Task Management Responsive */
        @media (max-width: 1200px) {
            .action-buttons .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            /* Hide text on smaller buttons, keep icons */
            .action-buttons .btn span {
                display: none;
            }

            .action-buttons .btn i {
                margin-right: 0;
            }
        }

        @media (max-width: 992px) {
            .task-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .search-filters {
                max-width: 100%;
                justify-content: center;
            }

            .action-buttons {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
        }

        @media (max-width: 768px) {
            .search-filters {
                flex-direction: column;
                gap: 12px;
            }

            .action-buttons .btn {
                flex: 1;
                min-width: 120px;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2c2c2c;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .modal-header {
            padding: 24px 30px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: #444;
            color: #fff;
        }

        .modal-body {
            padding: 30px;
        }

        .modal .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal .form-row.full-width {
            grid-template-columns: 1fr;
        }

        .modal .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #fff;
            font-weight: 500;
        }

        .modal .form-group label.required::after {
            content: ' *';
            color: #ff4d4f;
        }

        .form-control {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        .form-control:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #444;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            background: #444;
            border: 1px solid #666;
            color: #ccc;
        }

        .btn-cancel:hover {
            background: #555;
            border-color: #777;
            color: #fff;
        }

        .level-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .level-task {
            background: #1890ff;
            color: #fff;
        }

        .level-monthly {
            background: #52c41a;
            color: #fff;
        }

        .level-personal {
            background: #fa8c16;
            color: #fff;
        }

        /* Multi-select styling */
        select[multiple] {
            min-height: 120px;
        }

        select[multiple] option {
            padding: 8px 12px;
            margin: 2px 0;
        }

        select[multiple] option:checked {
            background: #00ff88;
            color: #1a1a1a;
        }

        /* Form section headers */
        .modal .form-section-header {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }

        .modal .form-section-header:first-child {
            margin-top: 0;
        }

        .modal .form-section-header:hover {
            color: #00cc6a;
        }

        .modal .form-section-header .collapse-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .modal .form-section-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .modal .form-section-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .modal .form-section-content.collapsed {
            max-height: 0;
            margin: 0;
            padding: 0;
            opacity: 0;
        }

        .modal .form-section-content:not(.collapsed) {
            max-height: 1000px;
            opacity: 1;
        }

        /* Required field indicator */
        .modal .form-group label.required {
            position: relative;
        }

        .modal .form-group label.required::after {
            content: ' *';
            color: #ff4d4f;
            font-weight: bold;
        }

        /* Auto-generated field styling */
        .modal .auto-field {
            background: #222 !important;
            color: #888 !important;
        }

        /* Help text */
        .modal .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        /* Lazy loading styles */
        .table-content-section {
            max-height: 600px;
            overflow-y: auto;
        }

        #loadingIndicator {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Approval button styling */
        .btn-approve {
            background: transparent !important;
            color: #00ff88 !important;
            border: 1px solid #00ff88 !important;
        }

        .btn-approve:hover {
            background: #00ff88 !important;
            color: #1a1a1a !important;
            border-color: #00ff88 !important;
        }

        .btn-approve i {
            color: inherit !important;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .toast {
            background: #333;
            color: #fff;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid #00ff88;
        }

        .toast.error {
            border-left: 4px solid #ff4d4f;
        }

        .toast.warning {
            border-left: 4px solid #ff9500;
        }

        .toast.info {
            border-left: 4px solid #1890ff;
        }

        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: #00ff88;
        }

        .toast.error .toast-icon {
            color: #ff4d4f;
        }

        .toast.warning .toast-icon {
            color: #ff9500;
        }

        .toast.info .toast-icon {
            color: #1890ff;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            opacity: 0.9;
        }

        .toast-close {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #fff;
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: #fff;
            margin-top: 16px;
            font-size: 14px;
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
        }

        /* Date input calendar icon styling */
        .modal input[type="date"] {
            color-scheme: dark;
            background: #333;
            border: 1px solid #555;
            color: #fff;
        }

        .modal input[type="date"]::-webkit-calendar-picker-indicator {
            background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='white' d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v1h14V3a1 1 0 0 0-1-1H2zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5z'/%3e%3c/svg%3e") no-repeat center;
            background-size: 16px 16px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 1;
        }

        .modal input[type="date"]::-webkit-calendar-picker-indicator:hover {
            background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='%2300ff88' d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v1h14V3a1 1 0 0 0-1-1H2zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5z'/%3e%3c/svg%3e") no-repeat center;
            background-size: 16px 16px;
        }

        /* Firefox date input */
        .modal input[type="date"]::-moz-calendar-picker-indicator {
            background: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='white' d='M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v1h14V3a1 1 0 0 0-1-1H2zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5z'/%3e%3c/svg%3e") no-repeat center;
            background-size: 16px 16px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-line" style="color: #00ff88; margin-right: 8px;"></i>
                    <span class="logo-text">KPI TT Cloud</span>
                </div>
                <button class="collapse-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <nav class="menu">
                <a href="index.html" class="menu-item">
                    <i class="fas fa-home menu-item-icon"></i>
                    <span class="menu-item-text">Trang chủ</span>
                </a>
                <a href="Task-Management.html" class="menu-item active">
                    <i class="fas fa-tasks menu-item-icon"></i>
                    <span class="menu-item-text">Quản lý Công việc</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-dollar-sign menu-item-icon"></i>
                    <span class="menu-item-text">Quản lý Doanh thu</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-shield-alt menu-item-icon"></i>
                    <span class="menu-item-text">Chất lượng Dịch vụ</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-graduation-cap menu-item-icon"></i>
                    <span class="menu-item-text">Quản lý Đào tạo</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-clipboard-check menu-item-icon"></i>
                    <span class="menu-item-text">Quản lý Tuân thủ</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-chart-bar menu-item-icon"></i>
                    <span class="menu-item-text">Dashboard KPI</span>
                </a>
                <div class="menu-item has-submenu" onclick="toggleSubmenu(this)">
                    <i class="fas fa-cog menu-item-icon"></i>
                    <span class="menu-item-text">Quản trị</span>
                    <i class="fas fa-chevron-down submenu-arrow"></i>
                </div>
                <div class="submenu">
                    <a href="User-Management.html" class="submenu-item">
                        <i class="fas fa-users submenu-item-icon"></i>
                        <span class="submenu-item-text">Quản lý Người dùng</span>
                    </a>
                    <a href="#" class="submenu-item">
                        <i class="fas fa-target submenu-item-icon"></i>
                        <span class="submenu-item-text">Cấu hình Targets</span>
                    </a>
                    <a href="#" class="submenu-item">
                        <i class="fas fa-balance-scale submenu-item-icon"></i>
                        <span class="submenu-item-text">Cấu hình Weights</span>
                    </a>
                    <a href="#" class="submenu-item">
                        <i class="fas fa-calculator submenu-item-icon"></i>
                        <span class="submenu-item-text">Cấu hình Formulas</span>
                    </a>
                    <a href="#" class="submenu-item">
                        <i class="fas fa-sliders-h submenu-item-icon"></i>
                        <span class="submenu-item-text">System Settings</span>
                    </a>
                </div>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="breadcrumb">
                    <span class="breadcrumb-item">
                        <i class="fas fa-home"></i>
                    </span>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-item">Quản lý Công việc</span>
                </div>
                
                <div class="user-info">
                    <span id="currentUserDisplay">Loading...</span>
                    <span id="currentUserRole" style="font-size: 12px; color: #00ff88; margin-left: 8px;"></span>
                    <div class="user-avatar" id="userAvatar">?</div>
                    <button class="logout-btn" onclick="logout()" title="Đăng xuất" style="margin-left: 12px; background: transparent; border: 1px solid #555; color: #fff; padding: 6px 10px; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>
            
            <!-- Content -->
            <main class="content">
                <!-- Task Controls -->
                <div class="task-controls">
                    <div class="search-filters">
                        <input type="text" class="search-box" placeholder="Tìm kiếm công việc..." id="searchInput">
                        <button class="btn-quick" id="myTasksBtn" onclick="toggleMyTasks()" title="Lọc công việc được giao cho tôi">
                            <i class="fas fa-user"></i> Của tôi
                        </button>
                        <select class="btn" id="teamFilter">
                            <option value="">Tất cả teams</option>
                            <option value="Team 1">Team 1 - Public Cloud Vmware</option>
                            <option value="Team 2">Team 2 - Public Cloud OpenStack</option>
                            <option value="Team 3">Team 3 - Private Cloud</option>
                            <option value="Team 4">Team 4 - Backup & DR</option>
                            <option value="Team 5">Team 5 - Network & Security</option>
                            <option value="Team 14">Team 14 - Management</option>
                        </select>
                        <select class="btn" id="statusFilter">
                            <option value="">Tất cả trạng thái</option>
                            <option value="not-started">Chưa thực hiện</option>
                            <option value="in-progress">Đang thực hiện</option>
                            <option value="pending-approval">Chờ phê duyệt</option>
                            <option value="completed">Hoàn thành</option>
                        </select>
                        <select class="btn" id="typeFilter">
                            <option value="">Tất cả loại</option>
                            <option value="nvtt">Nhiệm vụ trọng tâm</option>
                            <option value="nvkh">Nhiệm vụ kế hoạch</option>
                            <option value="cthd">CTHĐ</option>
                            <option value="tnkh">TNKH</option>
                            <option value="netbi">NetBI</option>
                        </select>
                        <button class="btn" id="clearFiltersBtn" onclick="clearAllFilters()" title="Xóa tất cả bộ lọc" style="display: none;">
                            <i class="fas fa-times"></i> Bỏ lọc
                        </button>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" onclick="exportTasks()" title="Export Excel">
                            <i class="fas fa-download"></i>
                            <span>Export Excel</span>
                        </button>
                        <button class="btn" onclick="importTasks()" title="Import Excel">
                            <i class="fas fa-upload"></i>
                            <span>Import Excel</span>
                        </button>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileImport(event)">
                        <button class="btn" onclick="downloadTemplate()" title="Tải Template">
                            <i class="fas fa-file-download"></i>
                            <span>Tải Template</span>
                        </button>
                        <button class="btn" onclick="bulkDelete()" title="Xóa nhiều">
                            <i class="fas fa-trash"></i>
                            <span>Xóa nhiều</span>
                        </button>
                        <button class="btn btn-primary" onclick="addTask()" title="Thêm công việc">
                            <i class="fas fa-plus"></i>
                            <span>Thêm công việc</span>
                        </button>
                    </div>
                </div>
                
                <!-- Task Table -->
                <div class="card">
                    <div class="table-header-section">
                        <h3 class="card-title">Danh sách Công việc</h3>
                        <div>
                            <span style="color: #ccc; font-size: 14px;">Tổng: <strong id="totalCount">25</strong> công việc</span>
                        </div>
                    </div>
                    <div class="table-content-section" style="padding: 0;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th style="width: 120px;" class="col-code">Mã công việc</th>
                                    <th style="width: 200px;" class="col-task">Nhiệm vụ</th>
                                    <th style="width: 180px;" class="col-monthly">Công việc từng tháng</th>
                                    <th style="width: 180px;" class="col-personal">Công việc cá nhân tháng</th>
                                    <th style="width: 150px;" class="col-team">Team chủ trì</th>
                                    <th style="width: 120px;" class="col-type">Loại công việc</th>
                                    <th style="width: 120px;" class="col-assignee">Người phụ trách</th>
                                    <th style="width: 100px;" class="col-progress">Tiến độ</th>
                                    <th style="width: 120px;" class="col-status">Trạng thái</th>
                                    <th style="width: 120px;" class="col-date">Ngày hoàn thành</th>
                                    <th style="width: 120px;" class="col-actions">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="taskTableBody">
                                <!-- Task rows will be populated by JavaScript -->
                            </tbody>
                        </table>

                        <!-- Loading indicator -->
                        <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px; color: #ccc;">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải thêm dữ liệu...
                        </div>

                        <!-- End of data indicator -->
                        <div id="endOfDataIndicator" style="display: none; text-align: center; padding: 20px; color: #888; font-style: italic;">
                            <i class="fas fa-check-circle"></i> Đã hiển thị tất cả dữ liệu
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Sample task data - Team 1 focused for testing
        const sampleTasks = [
            // === TASK LEVEL - Team 1 ===
            {
                id: 1,
                code: 'PC1_001',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Nâng cấp hạ tầng ảo hóa lên phiên bản mới nhất',
                dod: 'Hệ thống vSphere 8.0 hoạt động ổn định, pass UAT',
                assignee: 'Nguyễn Văn A',
                collaborators: ['Team 5 - Network & Security', 'Team 4 - Backup & DR'],
                plannedStartDate: '2024-11-01',
                plannedEndDate: '2024-12-30',
                actualStartDate: '2024-11-08', // 7 days delay
                actualEndDate: '',
                startDate: '2024-11-01', // Legacy field for compatibility
                dueDate: '2024-12-30', // Legacy field for compatibility
                progress: 75,
                status: 'in-progress',
                notes: 'Đang trong giai đoạn testing',
                selected: false
            },
            // === MONTHLY LEVEL - Child of PC1_001 ===
            {
                id: 101,
                code: 'PC1_001_001',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cài đặt và cấu hình ESXi hosts',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Nâng cấp hạ tầng ảo hóa lên phiên bản mới nhất',
                dod: 'ESXi hosts được cài đặt và cấu hình thành công',
                assignee: 'Nguyễn Văn A',
                collaborators: ['Team 5 - Network & Security'],
                parent: 'PC1_001',
                plannedStartDate: '2024-11-01',
                plannedEndDate: '2024-11-30',
                actualStartDate: '2024-11-08',
                actualEndDate: '',
                startDate: '2024-11-01',
                dueDate: '2024-11-30',
                progress: 80,
                status: 'in-progress',
                notes: 'Đã cài đặt 8/10 hosts',
                selected: false
            },
            // === PERSONAL LEVEL - Child of PC1_001_001 ===
            {
                id: 201,
                code: 'PC1_001_001_001',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cài đặt và cấu hình ESXi hosts',
                personalWork: 'Cài đặt ESXi 8.0 trên server vật lý',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Nâng cấp hạ tầng ảo hóa lên phiên bản mới nhất',
                dod: 'ESXi 8.0 được cài đặt và join vào cluster',
                assignee: 'Nguyễn Văn A',
                collaborators: [],
                parent: 'PC1_001_001',
                plannedStartDate: '2024-11-01',
                plannedEndDate: '2024-11-15',
                actualStartDate: '2024-11-08',
                actualEndDate: '2024-11-14',
                startDate: '2024-11-01',
                dueDate: '2024-11-15',
                progress: 100,
                status: 'pending-approval',
                notes: 'Đã hoàn thành, chờ PM phê duyệt',
                selected: false
            },
            {
                id: 2,
                code: 'PC1_002',
                title: 'Triển khai VMware NSX-T 4.0',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Tính năng mới',
                product: 'VMware NSX-T',
                objective: 'Triển khai giải pháp network virtualization',
                dod: 'NSX-T hoạt động ổn định, tích hợp với vSphere',
                assignee: 'Trần Văn B',
                collaborators: ['Team 5 - Network & Security'],
                plannedStartDate: '2025-01-15',
                plannedEndDate: '2025-03-31',
                actualStartDate: '',
                actualEndDate: '',
                startDate: '2025-01-15',
                dueDate: '2025-03-31',
                progress: 0,
                status: 'not-started',
                notes: 'Chờ hoàn thành vSphere 8.0',
                selected: false
            },
            {
                id: 3,
                code: 'PC1_003',
                title: 'Nâng cấp VMware vRealize Suite',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Nâng cấp',
                product: 'VMware vRealize',
                objective: 'Nâng cấp toàn bộ vRealize Suite lên phiên bản mới',
                dod: 'vRealize Operations, Automation hoạt động ổn định',
                assignee: 'Lê Thị C',
                collaborators: ['Team 7 - Monitoring'],
                startDate: '2025-02-01',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-04-30',
                notes: '',
                selected: false
            },

            // === MONTHLY LEVEL - PC1_001 ===
            {
                id: 4,
                code: 'PC1_001_001',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cài đặt và cấu hình hạ tầng cơ bản',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Hoàn thành cài đặt ESXi và vCenter',
                dod: 'ESXi hosts và vCenter hoạt động ổn định',
                assignee: 'Nguyễn Văn A',
                collaborators: ['Trần Văn B'],
                plannedStartDate: '2024-11-01',
                plannedEndDate: '2024-11-30',
                actualStartDate: '2024-11-01',
                actualEndDate: '2024-12-05', // 5 days delay
                startDate: '2024-11-01',
                dueDate: '2024-11-30',
                progress: 100,
                status: 'pending-approval',
                notes: 'Đã hoàn thành, chờ CPO phê duyệt',
                selected: false
            },
            {
                id: 5,
                code: 'PC1_001_002',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cấu hình networking và storage',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Cấu hình distributed switch và storage policy',
                dod: 'Network và storage hoạt động theo thiết kế',
                assignee: 'Trần Văn B',
                collaborators: ['Team 5 - Network & Security'],
                startDate: '2024-12-01',
                progress: 85,
                status: 'in-progress',
                dueDate: '2024-12-31',
                notes: 'Đang cấu hình storage policy',
                selected: false
            },

            // === PERSONAL LEVEL - PC1_001_001 ===
            {
                id: 6,
                code: 'PC1_001_001_001',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cài đặt và cấu hình hạ tầng cơ bản',
                personalWork: 'Cài đặt ESXi hosts',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Cài đặt 10 ESXi hosts',
                dod: 'Tất cả ESXi hosts online và healthy',
                assignee: 'Nguyễn Văn A',
                collaborators: [],
                startDate: '2024-11-01',
                progress: 100,
                status: 'completed',
                dueDate: '2024-11-15',
                notes: 'Hoàn thành đúng hạn',
                selected: false
            },
            {
                id: 7,
                code: 'PC1_001_001_002',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cài đặt và cấu hình hạ tầng cơ bản',
                personalWork: 'Cài đặt và cấu hình vCenter Server',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Triển khai vCenter Server Appliance',
                dod: 'vCenter hoạt động ổn định, quản lý được tất cả ESXi',
                assignee: 'Trần Văn B',
                collaborators: [],
                startDate: '2024-11-16',
                progress: 100,
                status: 'completed',
                dueDate: '2024-11-30',
                notes: 'Hoàn thành và đã test',
                selected: false
            },

            // === PERSONAL LEVEL - PC1_001_002 ===
            {
                id: 8,
                code: 'PC1_001_002_001',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cấu hình networking và storage',
                personalWork: 'Cấu hình distributed switch',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Tạo và cấu hình distributed switch cho toàn cluster',
                dod: 'Distributed switch hoạt động, VM có thể communicate',
                assignee: 'Trần Văn B',
                collaborators: ['Team 5 - Network & Security'],
                startDate: '2024-12-01',
                progress: 90,
                status: 'in-progress',
                dueDate: '2024-12-15',
                notes: 'Đang test connectivity',
                selected: false
            },
            {
                id: 9,
                code: 'PC1_001_002_002',
                title: 'Triển khai VMware vSphere 8.0',
                monthlyWork: 'Cấu hình networking và storage',
                personalWork: 'Cấu hình storage policy và datastore',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'VMware vSphere',
                objective: 'Cấu hình storage policy cho các workload khác nhau',
                dod: 'Storage policy hoạt động, VM placement đúng theo policy',
                assignee: 'Lê Thị C',
                collaborators: [],
                startDate: '2024-12-16',
                progress: 60,
                status: 'in-progress',
                dueDate: '2024-12-31',
                notes: 'Đang cấu hình policy cho production workload',
                selected: false
            },

            // === MONTHLY LEVEL - PC1_002 (NSX-T) ===
            {
                id: 10,
                code: 'PC1_002_001',
                title: 'Triển khai VMware NSX-T 4.0',
                monthlyWork: 'Lập kế hoạch và chuẩn bị hạ tầng',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Tính năng mới',
                product: 'VMware NSX-T',
                objective: 'Hoàn thành thiết kế và chuẩn bị hạ tầng cho NSX-T',
                dod: 'Thiết kế được approve, hạ tầng sẵn sàng',
                assignee: 'Trần Văn B',
                collaborators: ['Team 5 - Network & Security'],
                startDate: '2025-01-15',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-02-15',
                notes: 'Chờ hoàn thành vSphere 8.0',
                selected: false
            },

            // === DIFFERENT STATUS EXAMPLES ===
            {
                id: 11,
                code: 'PC1_004',
                title: 'Backup và DR cho VMware Infrastructure',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Bảo mật',
                product: 'VMware vSphere',
                objective: 'Thiết lập backup và disaster recovery',
                dod: 'Backup tự động, DR site hoạt động',
                assignee: 'Phạm Văn D',
                collaborators: ['Team 4 - Backup & DR'],
                startDate: '2025-03-01',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-05-31',
                notes: 'Phụ thuộc vào hoàn thành vSphere 8.0',
                selected: false
            },
            {
                id: 12,
                code: 'PC1_005',
                title: 'Monitoring và Alerting cho VMware',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Tính năng mới',
                product: 'VMware vRealize',
                objective: 'Triển khai monitoring toàn diện cho VMware infrastructure',
                dod: 'Monitoring dashboard hoạt động, alert được cấu hình',
                assignee: 'Nguyễn Thị E',
                collaborators: ['Team 7 - Monitoring'],
                startDate: '2025-04-01',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-06-30',
                notes: 'Tích hợp với vRealize Operations',
                selected: false
            },

            // === OTHER TEAMS FOR COMPARISON ===
            {
                id: 13,
                code: 'PC2_001',
                title: 'Cập nhật OpenStack Zed',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 2 - Public Cloud OpenStack',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Nâng cấp',
                product: 'OpenStack',
                objective: 'Nâng cấp OpenStack lên phiên bản Zed',
                dod: 'OpenStack Zed hoạt động ổn định',
                assignee: 'Trần Thị B',
                collaborators: [],
                startDate: '2024-10-01',
                progress: 100,
                status: 'completed',
                dueDate: '2024-12-15',
                notes: 'Hoàn thành thành công',
                selected: false
            },
            {
                id: 14,
                code: 'PC3_001',
                title: 'Triển khai Private Cloud với Hyper-V',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 3 - Private Cloud',
                type: 'Nhiệm vụ trọng tâm',
                nature: 'Sản phẩm mới',
                product: 'Microsoft Hyper-V',
                objective: 'Xây dựng private cloud cho khách hàng enterprise',
                dod: 'Private cloud hoạt động, khách hàng accept',
                assignee: 'Lê Văn C',
                collaborators: ['Team 5 - Network & Security'],
                startDate: '2024-11-01',
                progress: 45,
                status: 'in-progress',
                dueDate: '2025-02-28',
                notes: 'Đang trong giai đoạn setup networking',
                selected: false
            },
            {
                id: 15,
                code: 'MG1_001',
                title: 'Lập kế hoạch KPI Q1 2025',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 14 - Management',
                type: 'Nhiệm vụ kế hoạch',
                nature: 'Quản lý',
                product: 'KPI System',
                objective: 'Xây dựng KPI targets cho Q1 2025',
                dod: 'KPI targets được approve bởi leadership',
                assignee: 'Trần Văn A',
                collaborators: ['All Teams'],
                startDate: '2024-12-01',
                progress: 30,
                status: 'in-progress',
                dueDate: '2024-12-31',
                notes: 'Đang thu thập input từ các team',
                selected: false
            },
            {
                id: 4,
                code: 'PC2_001',
                title: 'Cập nhật OpenStack Zed',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 2 - Public Cloud OpenStack',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Trần Thị B',
                progress: 100,
                status: 'completed',
                dueDate: '2024-12-15',
                selected: false
            },
            {
                id: 5,
                code: 'PC2_001_001_001',
                title: 'Cập nhật OpenStack Zed',
                monthlyWork: 'Nâng cấp từ Yoga lên Zed',
                personalWork: 'Backup database và cấu hình',
                level: 'personal',
                team: 'Team 2 - Public Cloud OpenStack',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Trần Thị B',
                progress: 90,
                status: 'in-progress',
                dueDate: '2024-12-20',
                selected: false
            },
            {
                id: 6,
                code: 'PC3_002',
                title: 'Thiết lập Private Cloud cho khách hàng X',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 3 - Private Cloud',
                type: 'CTHĐ',
                assignee: 'Lê Văn C',
                progress: 45,
                status: 'in-progress',
                dueDate: '2025-01-15',
                selected: false
            },
            {
                id: 7,
                code: 'BDR_001',
                title: 'Backup solution cho hệ thống core',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 4 - Backup & DR',
                type: 'TNKH',
                assignee: 'Phạm Thị D',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-02-28',
                selected: false
            },
            {
                id: 8,
                code: 'NS_001_001_001',
                title: 'Nâng cấp firewall cluster',
                monthlyWork: 'Triển khai firewall mới',
                personalWork: 'Cấu hình rules và policies',
                level: 'personal',
                team: 'Team 5 - Network & Security',
                type: 'NetBI',
                assignee: 'Hoàng Văn E',
                progress: 85,
                status: 'in-progress',
                dueDate: '2024-12-25',
                selected: false
            },
            {
                id: 9,
                code: 'PC1_002',
                title: 'Triển khai vSAN Storage',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 30,
                status: 'in-progress',
                dueDate: '2025-01-30',
                selected: false
            },
            {
                id: 10,
                code: 'PC1_002_001',
                title: 'Triển khai vSAN Storage',
                monthlyWork: 'Thiết kế kiến trúc vSAN',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 60,
                status: 'in-progress',
                dueDate: '2025-01-15',
                selected: false
            },
            {
                id: 11,
                code: 'PC1_002_001_001',
                title: 'Triển khai vSAN Storage',
                monthlyWork: 'Thiết kế kiến trúc vSAN',
                personalWork: 'Lập kế hoạch capacity và performance',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 80,
                status: 'in-progress',
                dueDate: '2025-01-10',
                selected: false
            },
            {
                id: 12,
                code: 'PC2_002',
                title: 'Tối ưu hóa OpenStack Performance',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 2 - Public Cloud OpenStack',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Trần Thị B',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-02-15',
                selected: false
            },
            {
                id: 13,
                code: 'PC2_002_001_001',
                title: 'Tối ưu hóa OpenStack Performance',
                monthlyWork: 'Monitoring và tuning database',
                personalWork: 'Cấu hình MariaDB Galera Cluster',
                level: 'personal',
                team: 'Team 2 - Public Cloud OpenStack',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Trần Thị B',
                progress: 25,
                status: 'in-progress',
                dueDate: '2025-01-20',
                selected: false
            },
            {
                id: 14,
                code: 'PC3_001',
                title: 'Xây dựng Private Cloud Template',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 3 - Private Cloud',
                type: 'CTHĐ',
                assignee: 'Lê Văn C',
                progress: 70,
                status: 'in-progress',
                dueDate: '2024-12-31',
                selected: false
            },
            {
                id: 15,
                code: 'PC3_001_001',
                title: 'Xây dựng Private Cloud Template',
                monthlyWork: 'Tạo VM templates chuẩn',
                personalWork: '',
                level: 'monthly',
                team: 'Team 3 - Private Cloud',
                type: 'CTHĐ',
                assignee: 'Lê Văn C',
                progress: 90,
                status: 'in-progress',
                dueDate: '2024-12-20',
                selected: false
            },
            {
                id: 16,
                code: 'PC3_001_001_001',
                title: 'Xây dựng Private Cloud Template',
                monthlyWork: 'Tạo VM templates chuẩn',
                personalWork: 'Template Windows Server 2022',
                level: 'personal',
                team: 'Team 3 - Private Cloud',
                type: 'CTHĐ',
                assignee: 'Lê Văn C',
                progress: 100,
                status: 'completed',
                dueDate: '2024-12-10',
                selected: false
            },
            {
                id: 17,
                code: 'PC3_001_001_002',
                title: 'Xây dựng Private Cloud Template',
                monthlyWork: 'Tạo VM templates chuẩn',
                personalWork: 'Template Ubuntu 22.04 LTS',
                level: 'personal',
                team: 'Team 3 - Private Cloud',
                type: 'CTHĐ',
                assignee: 'Lê Văn C',
                progress: 95,
                status: 'in-progress',
                dueDate: '2024-12-18',
                selected: false
            },
            {
                id: 18,
                code: 'BDR_001_001',
                title: 'Backup solution cho hệ thống core',
                monthlyWork: 'Thiết kế backup strategy',
                personalWork: '',
                level: 'monthly',
                team: 'Team 4 - Backup & DR',
                type: 'TNKH',
                assignee: 'Phạm Thị D',
                progress: 40,
                status: 'in-progress',
                dueDate: '2025-01-15',
                selected: false
            },
            {
                id: 19,
                code: 'BDR_001_001_001',
                title: 'Backup solution cho hệ thống core',
                monthlyWork: 'Thiết kế backup strategy',
                personalWork: 'Nghiên cứu Veeam Backup & Replication',
                level: 'personal',
                team: 'Team 4 - Backup & DR',
                type: 'TNKH',
                assignee: 'Phạm Thị D',
                progress: 60,
                status: 'in-progress',
                dueDate: '2025-01-10',
                selected: false
            },
            {
                id: 20,
                code: 'BDR_002',
                title: 'Disaster Recovery Planning',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 4 - Backup & DR',
                type: 'TNKH',
                assignee: 'Phạm Thị D',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-03-31',
                selected: false
            },
            {
                id: 21,
                code: 'NS_001',
                title: 'Nâng cấp firewall cluster',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 5 - Network & Security',
                type: 'NetBI',
                assignee: 'Hoàng Văn E',
                progress: 85,
                status: 'in-progress',
                dueDate: '2024-12-25',
                selected: false
            },
            {
                id: 22,
                code: 'NS_001_001',
                title: 'Nâng cấp firewall cluster',
                monthlyWork: 'Triển khai firewall mới',
                personalWork: '',
                level: 'monthly',
                team: 'Team 5 - Network & Security',
                type: 'NetBI',
                assignee: 'Hoàng Văn E',
                progress: 90,
                status: 'in-progress',
                dueDate: '2024-12-20',
                selected: false
            },
            {
                id: 23,
                code: 'NS_002',
                title: 'Triển khai Zero Trust Network',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 5 - Network & Security',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Hoàng Văn E',
                progress: 15,
                status: 'in-progress',
                dueDate: '2025-04-30',
                selected: false
            },
            {
                id: 24,
                code: 'NS_002_001_001',
                title: 'Triển khai Zero Trust Network',
                monthlyWork: 'Nghiên cứu và thiết kế kiến trúc',
                personalWork: 'Đánh giá các giải pháp Zero Trust',
                level: 'personal',
                team: 'Team 5 - Network & Security',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Hoàng Văn E',
                progress: 30,
                status: 'in-progress',
                dueDate: '2025-01-31',
                selected: false
            },
            {
                id: 25,
                code: 'PC1_003',
                title: 'Migrate legacy workloads to vSphere 8',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Nguyễn Văn A',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-06-30',
                selected: false
            },
            // Team 1 - Complete hierarchy for testing
            {
                id: 26,
                code: 'PC1_004',
                title: 'Triển khai VMware Cloud Foundation',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-12-31',
                selected: false
            },
            {
                id: 27,
                code: 'PC1_004_001',
                title: 'Triển khai VMware Cloud Foundation',
                monthlyWork: 'Thiết kế và chuẩn bị hạ tầng VCF',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 25,
                status: 'in-progress',
                dueDate: '2025-03-31',
                selected: false
            },
            {
                id: 28,
                code: 'PC1_004_001_001',
                title: 'Triển khai VMware Cloud Foundation',
                monthlyWork: 'Thiết kế và chuẩn bị hạ tầng VCF',
                personalWork: 'Cài đặt SDDC Manager và ESXi hosts',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-01-31',
                selected: false
            },
            {
                id: 29,
                code: 'PC1_004_001_002',
                title: 'Triển khai VMware Cloud Foundation',
                monthlyWork: 'Thiết kế và chuẩn bị hạ tầng VCF',
                personalWork: 'Cấu hình vSAN và NSX-T networking',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 30,
                status: 'in-progress',
                dueDate: '2025-02-15',
                selected: false
            },
            {
                id: 30,
                code: 'PC1_004_002',
                title: 'Triển khai VMware Cloud Foundation',
                monthlyWork: 'Cấu hình và tối ưu hóa VCF',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-06-30',
                selected: false
            },
            {
                id: 31,
                code: 'PC1_004_002_001',
                title: 'Triển khai VMware Cloud Foundation',
                monthlyWork: 'Cấu hình và tối ưu hóa VCF',
                personalWork: 'Setup vRealize Suite và monitoring',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Nguyễn Văn A',
                progress: 0,
                status: 'not-started',
                dueDate: '2025-04-30',
                selected: false
            },
            {
                id: 32,
                code: 'PC1_005',
                title: 'Nâng cấp vCenter Server lên phiên bản 8.0',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Nguyễn Văn A',
                progress: 100,
                status: 'completed',
                dueDate: '2024-12-15',
                selected: false
            },
            {
                id: 33,
                code: 'PC1_005_001',
                title: 'Nâng cấp vCenter Server lên phiên bản 8.0',
                monthlyWork: 'Backup và chuẩn bị nâng cấp',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Nguyễn Văn A',
                progress: 100,
                status: 'completed',
                dueDate: '2024-11-30',
                selected: false
            },
            {
                id: 34,
                code: 'PC1_005_001_001',
                title: 'Nâng cấp vCenter Server lên phiên bản 8.0',
                monthlyWork: 'Backup và chuẩn bị nâng cấp',
                personalWork: 'Backup cấu hình vCenter và database',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ kế hoạch',
                assignee: 'Nguyễn Văn A',
                progress: 100,
                status: 'completed',
                dueDate: '2024-11-15',
                selected: false
            },
            // Team 6 - DevOps tasks for Nguyễn Văn A
            {
                id: 35,
                code: 'PA1_001',
                title: 'Triển khai CI/CD Pipeline với GitLab',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 6 - DevOps',
                type: 'Sản phẩm mới',
                assignee: 'Nguyễn Văn A',
                progress: 45,
                status: 'in-progress',
                dueDate: '2025-02-28',
                selected: false
            },
            {
                id: 36,
                code: 'PA1_001_001',
                title: 'Triển khai CI/CD Pipeline với GitLab',
                monthlyWork: 'Setup GitLab Runner và Docker Registry',
                personalWork: '',
                level: 'monthly',
                team: 'Team 6 - DevOps',
                type: 'Sản phẩm mới',
                assignee: 'Nguyễn Văn A',
                progress: 80,
                status: 'in-progress',
                dueDate: '2025-01-31',
                selected: false
            },
            // Test data for rejection logic - Task level with ALL children at 100%
            {
                id: 37,
                code: 'PC1_006',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: '',
                personalWork: '',
                level: 'task',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-03-31',
                selected: false
            },
            {
                id: 38,
                code: 'PC1_006_001',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: 'Cài đặt và cấu hình ESXi hosts',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-01-31',
                selected: false
            },
            {
                id: 39,
                code: 'PC1_006_002',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: 'Cấu hình vCenter và networking',
                personalWork: '',
                level: 'monthly',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-02-28',
                selected: false
            },
            {
                id: 40,
                code: 'PC1_006_001_001',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: 'Cài đặt và cấu hình ESXi hosts',
                personalWork: 'Cài đặt ESXi 8.0 trên physical servers',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-01-15',
                selected: false
            },
            {
                id: 41,
                code: 'PC1_006_001_002',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: 'Cài đặt và cấu hình ESXi hosts',
                personalWork: 'Cấu hình network và storage cho ESXi',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-01-20',
                selected: false
            },
            {
                id: 42,
                code: 'PC1_006_002_001',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: 'Cấu hình vCenter và networking',
                personalWork: 'Cài đặt và cấu hình vCenter Server',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-02-15',
                selected: false
            },
            {
                id: 43,
                code: 'PC1_006_002_002',
                title: 'Triển khai vSphere 8.0 Infrastructure',
                monthlyWork: 'Cấu hình vCenter và networking',
                personalWork: 'Cấu hình distributed switch và VLAN',
                level: 'personal',
                team: 'Team 1 - Public Cloud Vmware',
                type: 'Nhiệm vụ trọng tâm',
                assignee: 'Trần Văn A',
                progress: 100,
                status: 'pending-approval',
                dueDate: '2025-02-20',
                selected: false
            }
        ];

        // Generate additional sample data for lazy loading testing
        function generateAdditionalTasks() {
            const additionalTasks = [];
            const teams = [
                'Team 2 - Public Cloud OpenStack',
                'Team 3 - Private Cloud',
                'Team 4 - Backup & DR',
                'Team 5 - Network & Security',
                'Team 7 - Monitoring',
                'Team 8 - DB',
                'Team 9 - Middleware',
                'Team 10 - Container'
            ];

            const taskTypes = ['Nhiệm vụ trọng tâm', 'Nhiệm vụ kế hoạch', 'CTHĐ', 'TNKH', 'NetBI'];
            const statuses = ['not-started', 'in-progress', 'pending-approval', 'completed'];
            const assignees = ['Trần Thị B', 'Lê Văn C', 'Phạm Thị D', 'Hoàng Văn E', 'Nguyễn Thị F'];

            for (let i = 37; i <= 80; i++) {
                const team = teams[Math.floor(Math.random() * teams.length)];
                const teamNumber = team.match(/Team (\d+)/)[1];
                let prefix = '';

                if (teamNumber <= 5) {
                    prefix = 'PC' + teamNumber;
                } else if (teamNumber <= 10) {
                    prefix = 'PA' + (teamNumber - 5);
                } else {
                    prefix = 'SW' + (teamNumber - 10);
                }

                additionalTasks.push({
                    id: i,
                    code: `${prefix}_${String(Math.floor(i/10) + 1).padStart(3, '0')}`,
                    title: `Công việc mẫu ${i} - ${team.split(' - ')[1]}`,
                    monthlyWork: '',
                    personalWork: '',
                    level: 'task',
                    team: team,
                    type: taskTypes[Math.floor(Math.random() * taskTypes.length)],
                    assignee: assignees[Math.floor(Math.random() * assignees.length)],
                    progress: Math.floor(Math.random() * 101),
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    dueDate: `2025-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    selected: false
                });
            }

            return additionalTasks;
        }

        // Add generated tasks to sample data (commented out for Team 1 focus)
        // sampleTasks.push(...generateAdditionalTasks());

        let filteredTasks = [...sampleTasks];
        let isMyTasksActive = false;

        // Authentication integration
        let currentUser = 'Unknown';
        let currentUserRole = 'Dev';
        let currentUserTeams = [];

        // Initialize user info from authentication
        async function initializeUserInfo() {
            try {
                console.log('Task Management: Initializing user info...');

                if (window.authManager && await window.authManager.loadUserSession()) {
                    const userInfo = window.authManager.getCurrentUser();
                    const permissions = window.authManager.getPermissions();

                    console.log('Task Management: User info loaded:', userInfo);

                    currentUser = userInfo.username;
                    currentUserRole = userInfo.roles ? userInfo.roles[0] : userInfo.role;
                    currentUserTeams = userInfo.teams || [];

                    // Update UI
                    document.getElementById('currentUserDisplay').textContent = userInfo.fullName || currentUser;
                    document.getElementById('currentUserRole').textContent = `(${currentUserRole})`;
                    document.getElementById('userAvatar').textContent = (userInfo.fullName || currentUser).charAt(0).toUpperCase();

                    // Filter tasks based on permissions
                    if (permissions.scope === 'team') {
                        filteredTasks = sampleTasks.filter(task =>
                            currentUserTeams.includes(task.team) ||
                            task.assignee === currentUser
                        );
                    } else {
                        filteredTasks = [...sampleTasks];
                    }

                    // Update UI based on permissions
                    updateUIBasedOnPermissions(permissions);

                    console.log('Task Management: Initialization complete');
                } else {
                    console.log('Task Management: No valid session, redirecting to login');
                    // Redirect to login if not authenticated
                    window.location.href = 'auth/login.html';
                }
            } catch (error) {
                console.error('Task Management: Initialization error:', error);
                // Fallback to demo mode or redirect to login
                window.location.href = 'auth/login.html';
            }
        }

        function updateUIBasedOnPermissions(permissions) {
            // Hide/show buttons based on permissions
            const addButton = document.querySelector('button[onclick="openTaskModal()"]');
            const importButton = document.querySelector('button[onclick="openImportWizard()"]');
            const bulkDeleteButton = document.querySelector('button[onclick="bulkDelete()"]');

            if (addButton) addButton.style.display = permissions.canCreate ? 'inline-flex' : 'none';
            if (importButton) importButton.style.display = permissions.canImport ? 'inline-flex' : 'none';
            if (bulkDeleteButton) bulkDeleteButton.style.display = permissions.canDelete ? 'inline-flex' : 'none';
        }

        // Lazy loading variables
        const ITEMS_PER_PAGE = 20; // Number of items to load per page
        let currentPage = 1;
        let isLoading = false;
        let hasMoreData = true;

        // User role and team mapping
        const userRoles = {
            'Trần Văn A': 'CPO',
            'Nguyễn Văn A': 'PM',
            'Trần Thị B': 'PO',
            'Lê Văn C': 'PM',
            'Phạm Thị D': 'Dev',
            'Hoàng Văn E': 'DevOps',
            'Nguyễn Thị F': 'BA',
            'Trần Văn G': 'Dev',
            'Lê Thị H': 'Tester'
        };

        const userTeams = {
            'Trần Văn A': ['Team 1 - Public Cloud Vmware', 'Team 2 - Public Cloud OpenStack', 'Team 3 - Private Cloud'], // CPO có quyền nhiều team
            'Nguyễn Văn A': ['Team 1 - Public Cloud Vmware', 'Team 6 - DevOps'],
            'Trần Thị B': ['Team 2 - Public Cloud OpenStack'],
            'Lê Văn C': ['Team 3 - Private Cloud', 'Team 14 - Management'],
            'Phạm Thị D': ['Team 4 - Backup & DR'],
            'Hoàng Văn E': ['Team 5 - Network & Security'],
            'Nguyễn Thị F': ['Team 7 - Monitoring', 'Team 8 - DB'],
            'Trần Văn G': ['Team 9 - Middleware'],
            'Lê Thị H': ['Team 10 - Container', 'Team 11 - ATM']
        };

        // Check if user can approve tasks - now uses authentication system
        function canApproveTask(task) {
            if (window.authManager) {
                return window.authManager.canApproveTask(task);
            }

            // Fallback for backward compatibility
            const userRole = currentUserRole;
            if (task.status !== 'pending-approval') return false;

            // CPO can approve monthly tasks
            if (userRole === 'CPO' && task.level === 'monthly') {
                return true;
            }

            // PM/PO can approve personal tasks from their teams
            if ((userRole === 'PM' || userRole === 'PO') && task.level === 'personal') {
                return currentUserTeams.includes(task.team);
            }

            return false;
        }

        // Check if user can create/edit tasks for a specific team
        function canEditTaskForTeam(team) {
            const userRole = currentUserRole;

            // Admin có quyền toàn hệ thống
            if (userRole === 'Admin') return true;

            // CPO có quyền xem/sửa toàn hệ thống
            if (userRole === 'CPO') return true;

            // PM/PO/Dev chỉ có quyền với team của mình
            return currentUserTeams.includes(team);
        }

        // Check if user can assign task to specific assignee - now uses authentication system
        function canAssignToUser(assignee, team) {
            if (window.authManager) {
                return window.authManager.canAssignToUser(assignee, team);
            }

            // Fallback for backward compatibility
            const userRole = currentUserRole;

            // Admin và CPO có quyền assign cho bất kỳ ai
            if (userRole === 'Admin' || userRole === 'CPO') return true;

            // PM/PO có thể assign trong team của mình
            if ((userRole === 'PM' || userRole === 'PO') && currentUserTeams.includes(team)) {
                return true;
            }

            // Dev chỉ có thể assign cho chính mình
            if (userRole === 'Dev' && assignee === currentUser) {
                return true;
            }

            return false;
        }

        // Check if user can import tasks (only Admin, CPO, PM, PO)
        function canImportTasks() {
            const userRole = currentUserRole;
            return ['Admin', 'CPO', 'PM', 'PO'].includes(userRole);
        }

        // Validate work code permission
        function validateWorkCodePermission(workCode, team) {
            const userRole = currentUserRole;

            // Admin và CPO có thể sử dụng bất kỳ mã nào
            if (userRole === 'Admin' || userRole === 'CPO') return true;

            // Extract prefix from work code (PC1, PC2, PA1, SW1, MG1, etc.)
            const codeMatch = workCode.match(/^([A-Z]{2,3}\d+)/);
            if (!codeMatch) return false;

            const prefix = codeMatch[1];

            // Map prefix to team number
            let expectedTeamNumber = null;
            if (prefix.startsWith('PC')) {
                expectedTeamNumber = parseInt(prefix.substring(2));
            } else if (prefix.startsWith('PA')) {
                expectedTeamNumber = parseInt(prefix.substring(2)) + 5;
            } else if (prefix.startsWith('SW')) {
                expectedTeamNumber = parseInt(prefix.substring(2)) + 10;
            } else if (prefix === 'MG1') {
                expectedTeamNumber = 14;
            }

            if (!expectedTeamNumber) return false;

            // Check if team matches the work code prefix
            const teamMatch = team.match(/Team (\d+)/);
            if (!teamMatch) return false;

            const actualTeamNumber = parseInt(teamMatch[1]);

            // User can only use work codes for their own teams
            if (actualTeamNumber !== expectedTeamNumber) return false;

            // Check if user has permission for this team
            return canEditTaskForTeam(team);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize authentication first
            await initializeUserInfo();

            renderTaskTable();
            setupEventListeners();
            updateColumnVisibility();
            setupModalEventListeners();
            setupInfiniteScroll();
            setupKeyboardShortcuts();
            initAutoSave();
            updateBulkActions();

            // Check for existing task delays
            setTimeout(() => {
                checkAllTaskDelays();
            }, 1000); // Delay to ensure UI is ready


        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', function() {
                filterTasks();
                updateColumnVisibility();
            });
            document.getElementById('teamFilter').addEventListener('change', function() {
                filterTasks();
                updateColumnVisibility();
            });
            document.getElementById('statusFilter').addEventListener('change', function() {
                filterTasks();
                updateColumnVisibility();
            });
            document.getElementById('typeFilter').addEventListener('change', function() {
                filterTasks();
                updateColumnVisibility();
            });
        }

        function renderTaskTable(append = false) {
            const tbody = document.getElementById('taskTableBody');

            if (!append) {
                tbody.innerHTML = '';
                currentPage = 1;
                hasMoreData = true;
            }

            // Calculate items to show
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const itemsToShow = filteredTasks.slice(startIndex, endIndex);

            // Update total count
            document.getElementById('totalCount').textContent = filteredTasks.length;

            // Check if there's more data
            hasMoreData = endIndex < filteredTasks.length;

            itemsToShow.forEach(task => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.setAttribute('data-task-id', task.id);
                row.setAttribute('data-selected', task.selected || false);

                row.innerHTML = `
                    <td onclick="event.stopPropagation();">
                        <input type="checkbox" ${task.selected ? 'checked' : ''}
                               onchange="toggleTaskSelection(${task.id})">
                    </td>
                    <td class="text-left col-code">${task.code}</td>
                    <td class="text-left col-task">
                        ${task.title}
                        ${task.delayWarning ? `<span class="delay-warning" title="${task.delayWarning}">⚠️</span>` : ''}
                    </td>
                    <td class="text-left col-monthly">${task.monthlyWork || '-'}</td>
                    <td class="text-left col-personal">${task.personalWork || '-'}</td>
                    <td class="col-team">${task.team ? task.team.split(' - ')[0] : ''}</td>
                    <td class="col-type">${task.type}</td>
                    <td class="col-assignee">${task.assignee}</td>
                    <td class="col-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <span style="font-size: 12px; color: #ccc;">${task.progress}%</span>
                    </td>
                    <td class="col-status">
                        <span class="status-badge status-${task.status}">
                            ${getStatusText(task.status)}
                        </span>
                    </td>
                    <td class="col-date">${formatDate(task.dueDate)}</td>
                    <td class="actions-cell col-actions" onclick="event.stopPropagation();">
                        <button class="btn-action" onclick="viewTask(${task.id})" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action" onclick="editTask(${task.id})" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${canApproveTask(task) ? `
                        <button class="btn-action btn-approve" onclick="approveTask(${task.id})" title="Phê duyệt">
                            <i class="fas fa-check"></i>
                        </button>
                        ` : ''}
                    </td>
                `;

                // Add click event to row for selection
                row.style.cursor = 'pointer';
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on action buttons or checkbox
                    if (e.target.closest('.actions-cell') || e.target.closest('input[type="checkbox"]')) {
                        return;
                    }
                    toggleTaskSelection(task.id);
                    updateSelectAllCheckbox();
                    updateBulkActions();
                });

                tbody.appendChild(row);
            });

            // Show loading indicator if there's more data
            updateLoadingIndicator();
        }

        function getStatusText(status) {
            const statusMap = {
                'not-started': 'Chưa thực hiện',
                'in-progress': 'Đang thực hiện',
                'pending-approval': 'Chờ phê duyệt',
                'completed': 'Hoàn thành'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function sortTasksByHierarchy(tasks) {
            // Sort tasks by hierarchy: Task level first, then Monthly, then Personal
            // Within each level, group by parent-child relationships

            const taskLevel = tasks.filter(t => t.level === 'task');
            const monthlyLevel = tasks.filter(t => t.level === 'monthly');
            const personalLevel = tasks.filter(t => t.level === 'personal');

            const sortedTasks = [];

            // Sort task level by code
            taskLevel.sort((a, b) => a.code.localeCompare(b.code));

            taskLevel.forEach(task => {
                // Add the main task
                sortedTasks.push(task);

                // Find and add its monthly children
                const monthlyChildren = monthlyLevel
                    .filter(m => m.parent === task.code)
                    .sort((a, b) => a.code.localeCompare(b.code));

                monthlyChildren.forEach(monthly => {
                    sortedTasks.push(monthly);

                    // Find and add its personal children
                    const personalChildren = personalLevel
                        .filter(p => p.parent === monthly.code)
                        .sort((a, b) => a.code.localeCompare(b.code));

                    personalChildren.forEach(personal => {
                        sortedTasks.push(personal);
                    });
                });
            });

            // Add orphaned monthly tasks (without parent)
            const orphanedMonthly = monthlyLevel.filter(m =>
                !m.parent || !taskLevel.find(t => t.code === m.parent)
            ).sort((a, b) => a.code.localeCompare(b.code));

            orphanedMonthly.forEach(monthly => {
                sortedTasks.push(monthly);

                // Add its personal children
                const personalChildren = personalLevel
                    .filter(p => p.parent === monthly.code)
                    .sort((a, b) => a.code.localeCompare(b.code));

                personalChildren.forEach(personal => {
                    sortedTasks.push(personal);
                });
            });

            // Add orphaned personal tasks (without parent)
            const orphanedPersonal = personalLevel.filter(p =>
                !p.parent || !monthlyLevel.find(m => m.code === p.parent)
            ).sort((a, b) => a.code.localeCompare(b.code));

            sortedTasks.push(...orphanedPersonal);

            return sortedTasks;
        }

        function filterTasks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const teamFilter = document.getElementById('teamFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filtered = sampleTasks.filter(task => {
                const matchesSearch = task.title.toLowerCase().includes(searchTerm) ||
                                    task.code.toLowerCase().includes(searchTerm) ||
                                    (task.monthlyWork && task.monthlyWork.toLowerCase().includes(searchTerm)) ||
                                    (task.personalWork && task.personalWork.toLowerCase().includes(searchTerm));
                // Team filter: match the team number part
                const matchesTeam = !teamFilter || (task.team && task.team.startsWith(teamFilter + ' -'));
                const matchesStatus = !statusFilter || task.status === statusFilter;
                const matchesType = !typeFilter || task.type.includes(typeFilter);
                const matchesMyTasks = !isMyTasksActive || task.assignee === currentUser;

                return matchesSearch && matchesTeam && matchesStatus && matchesType && matchesMyTasks;
            });

            // Sort by hierarchy
            filteredTasks = sortTasksByHierarchy(filtered);

            renderTaskTable();
            updateClearButtonVisibility();
        }

        function updateLoadingIndicator() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const endOfDataIndicator = document.getElementById('endOfDataIndicator');

            if (hasMoreData) {
                loadingIndicator.style.display = 'none';
                endOfDataIndicator.style.display = 'none';
            } else {
                loadingIndicator.style.display = 'none';
                endOfDataIndicator.style.display = filteredTasks.length > ITEMS_PER_PAGE ? 'block' : 'none';
            }
        }

        function loadMoreTasks() {
            if (isLoading || !hasMoreData) return;

            isLoading = true;
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';

            // Simulate loading delay
            setTimeout(() => {
                currentPage++;
                renderTaskTable(true); // Append mode
                isLoading = false;
            }, 500);
        }

        function setupInfiniteScroll() {
            const tableContainer = document.querySelector('.table-content-section');

            tableContainer.addEventListener('scroll', function() {
                const scrollTop = this.scrollTop;
                const scrollHeight = this.scrollHeight;
                const clientHeight = this.clientHeight;

                // Load more when scrolled to 80% of the content
                if (scrollTop + clientHeight >= scrollHeight * 0.8) {
                    loadMoreTasks();
                }
            });
        }

        function updateClearButtonVisibility() {
            const searchTerm = document.getElementById('searchInput').value;
            const teamFilter = document.getElementById('teamFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            const clearBtn = document.getElementById('clearFiltersBtn');
            const myTasksBtn = document.getElementById('myTasksBtn');

            // Check if any standard filter is active (excluding myTasks)
            const hasStandardFilters = searchTerm || teamFilter || statusFilter || typeFilter;

            // Only show "Bỏ lọc" button when standard filters are active
            // "Của tôi" button can toggle itself, no need for clear button
            if (hasStandardFilters) {
                clearBtn.style.display = 'inline-flex';
            } else {
                clearBtn.style.display = 'none';
            }

            // Hide "Của tôi" button when standard filters are active to maintain layout
            if (hasStandardFilters) {
                myTasksBtn.style.display = 'none';
            } else {
                myTasksBtn.style.display = 'inline-flex';
            }
        }

        function toggleMyTasks() {
            isMyTasksActive = !isMyTasksActive;
            const myTasksBtn = document.getElementById('myTasksBtn');

            if (isMyTasksActive) {
                myTasksBtn.classList.add('active');
            } else {
                myTasksBtn.classList.remove('active');
            }

            filterTasks();
            updateColumnVisibility();
        }

        function updateColumnVisibility() {
            const teamFilter = document.getElementById('teamFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            // Get all column elements
            const teamCols = document.querySelectorAll('.col-team');
            const statusCols = document.querySelectorAll('.col-status');
            const typeCols = document.querySelectorAll('.col-type');

            // Reset all columns to visible
            teamCols.forEach(col => col.classList.remove('col-hidden'));
            statusCols.forEach(col => col.classList.remove('col-hidden'));
            typeCols.forEach(col => col.classList.remove('col-hidden'));

            // Hide columns when filtering
            if (teamFilter) {
                // When filtering by team, hide team column
                teamCols.forEach(col => col.classList.add('col-hidden'));
            }

            if (statusFilter) {
                // When filtering by status, hide status column
                statusCols.forEach(col => col.classList.add('col-hidden'));
            }

            if (typeFilter) {
                // When filtering by type, hide type column
                typeCols.forEach(col => col.classList.add('col-hidden'));
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const isSelectingAll = selectAll.checked;

            filteredTasks.forEach(task => {
                task.selected = isSelectingAll;
            });

            // Update visual state immediately without full re-render
            const rows = document.querySelectorAll('#taskTableBody tr[data-task-id]');
            const checkboxes = document.querySelectorAll('#taskTableBody input[type="checkbox"]');

            rows.forEach(row => {
                row.setAttribute('data-selected', isSelectingAll);
            });

            checkboxes.forEach(checkbox => {
                checkbox.checked = isSelectingAll;
            });

            updateBulkActions();

            // Show feedback toast
            const count = filteredTasks.length;
            const message = isSelectingAll ? `Đã chọn ${count} công việc` : 'Đã bỏ chọn tất cả';
            showToast(isSelectingAll ? 'Chọn tất cả' : 'Bỏ chọn', message, 'info', 2000);
        }

        function toggleTaskSelection(taskId) {
            const task = sampleTasks.find(t => t.id === taskId);
            if (task) {
                task.selected = !task.selected;
                // Update the checkbox in the table
                const checkbox = document.querySelector(`input[onchange*="${taskId}"]`);
                if (checkbox) {
                    checkbox.checked = task.selected;
                }
                // Update row visual state
                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (row) {
                    row.setAttribute('data-selected', task.selected);
                }
                updateSelectAllCheckbox();
                updateBulkActions();
            }
        }

        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const visibleTasks = filteredTasks;
            const selectedVisibleTasks = visibleTasks.filter(task => task.selected);

            if (selectedVisibleTasks.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedVisibleTasks.length === visibleTasks.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function updateBulkActions() {
            const selectedTasks = sampleTasks.filter(task => task.selected);
            const bulkDeleteBtn = document.querySelector('button[onclick="bulkDelete()"]');

            if (selectedTasks.length > 0) {
                bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Xóa nhiều (${selectedTasks.length})`;
                bulkDeleteBtn.style.backgroundColor = '#dc3545';
                bulkDeleteBtn.style.color = 'white';
                bulkDeleteBtn.style.fontWeight = 'bold';
            } else {
                bulkDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> Xóa nhiều`;
                bulkDeleteBtn.style.backgroundColor = '';
                bulkDeleteBtn.style.color = '';
                bulkDeleteBtn.style.fontWeight = '';
            }
        }

        function clearAllFilters() {
            // Reset all filter controls
            document.getElementById('searchInput').value = '';
            document.getElementById('teamFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';

            // Reset my tasks filter
            isMyTasksActive = false;
            document.getElementById('myTasksBtn').classList.remove('active');

            // Trigger filter update
            filterTasks();
            updateColumnVisibility();
            updateClearButtonVisibility();
        }

        // Modal and Task Management Functions
        let currentEditingTaskId = null;

        function addTask() {
            try {
                console.log('addTask called'); // Debug log
                currentEditingTaskId = null;

                const modalTitle = document.getElementById('modalTitle');
                if (modalTitle) {
                    modalTitle.textContent = 'Thêm công việc mới';
                } else {
                    console.error('modalTitle element not found');
                }

                resetTaskForm();
                setFormSectionsForAdd(); // Expand all sections for new task

                const taskModal = document.getElementById('taskModal');
                if (taskModal) {
                    taskModal.classList.add('show');
                    console.log('Modal should be visible now');
                    console.log('Modal classes:', taskModal.className);
                    console.log('Modal display:', window.getComputedStyle(taskModal).display);
                    console.log('Modal z-index:', window.getComputedStyle(taskModal).zIndex);
                } else {
                    console.error('taskModal element not found');
                }
            } catch (error) {
                console.error('Error in addTask:', error);
            }
        }

        function editTask(taskId) {
            try {
                console.log('editTask called with taskId:', taskId);
                currentEditingTaskId = taskId;
                const task = sampleTasks.find(t => t.id === taskId);
                if (!task) {
                    console.error('Task not found:', taskId);
                    return;
                }

                console.log('Found task:', task);

                const modalTitle = document.getElementById('modalTitle');
                if (modalTitle) {
                    modalTitle.textContent = 'Chỉnh sửa công việc';
                } else {
                    console.error('modalTitle not found');
                }

                populateTaskForm(task);

                // Show approval section if user can approve this task
                updateApprovalSection(task);

                // Collapse sections for edit mode - focus on essential info
                setFormSectionsForEdit();

                const taskModal = document.getElementById('taskModal');
                if (taskModal) {
                    taskModal.classList.add('show');
                    console.log('Edit modal should be visible now');
                } else {
                    console.error('taskModal not found');
                }

                // Load draft if available
                setTimeout(() => loadDraft(taskId), 100);
            } catch (error) {
                console.error('Error in editTask:', error);
            }
        }

        function viewTask(taskId) {
            const task = sampleTasks.find(t => t.id === taskId);
            if (!task) return;

            // For now, just show an alert with task details
            const details = `
Mã: ${task.code}
Tên: ${task.title}
Team: ${task.team}
Người thực hiện: ${task.assignee}
Tiến độ: ${task.progress}%
Trạng thái: ${getStatusText(task.status)}
Hạn: ${formatDate(task.dueDate)}
            `.trim();

            alert(details);
        }

        function approveTask(taskId) {
            const task = sampleTasks.find(t => t.id === taskId);
            if (!task) return;

            if (!canApproveTask(task)) {
                alert('Bạn không có quyền phê duyệt công việc này');
                return;
            }

            const approvalType = task.level === 'monthly' ? 'CPO' : 'PM/PO';
            const confirmMessage = `Bạn có chắc chắn muốn phê duyệt công việc này?\n\nMã: ${task.code}\nTên: ${task.title}\nLoại phê duyệt: ${approvalType}`;

            if (confirm(confirmMessage)) {
                showLoading('Đang phê duyệt...');

                // Simulate async operation
                setTimeout(() => {
                    // Update task status to completed
                    task.status = 'completed';

                    // Refresh the table
                    filterTasks();

                    hideLoading();

                    // Show success message
                    showToast('Phê duyệt thành công!', `Công việc "${task.title}" đã được phê duyệt`, 'success');
                }, 600);
            }
        }

        function updateApprovalSection(task) {
            try {
                const approvalSection = document.getElementById('approvalSection');
                const approvalInfo = document.getElementById('approvalInfo');

                if (!approvalSection) {
                    console.log('approvalSection not found - skipping approval update');
                    return;
                }

                if (canApproveTask(task)) {
                    approvalSection.style.display = 'block';

                    if (approvalInfo) {
                        const approvalType = task.level === 'monthly' ? 'CPO' : 'PM/PO';
                        const levelText = task.level === 'monthly' ? 'Công việc từng tháng' : 'Công việc cá nhân tháng';

                        approvalInfo.innerHTML = `
                            <div><strong>Loại công việc:</strong> ${levelText}</div>
                            <div><strong>Người phê duyệt:</strong> ${approvalType}</div>
                            <div><strong>Tiến độ:</strong> ${task.progress}% (Hoàn thành)</div>
                            <div><strong>Mô tả:</strong> ${task.title}</div>
                        `;
                    }
                } else {
                    approvalSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Error in updateApprovalSection:', error);
            }
        }

        function approveTaskInForm() {
            if (!currentEditingTaskId) return;

            const task = sampleTasks.find(t => t.id === currentEditingTaskId);
            if (!task || !canApproveTask(task)) return;

            // Update task status to completed
            task.status = 'completed';

            // Close modal and refresh table
            closeTaskModal();
            filterTasks();

            alert(`✅ Đã phê duyệt thành công!\n\nCông việc "${task.title}" đã được chuyển sang trạng thái "Hoàn thành".`);
        }

        function rejectTaskInForm() {
            if (!currentEditingTaskId) return;

            const task = sampleTasks.find(t => t.id === currentEditingTaskId);
            if (!task || !canApproveTask(task)) return;

            // Find all child tasks that are at 100% (these contributed to parent being 100%)
            const childTasks = findCompletedChildTasks(task);

            if (childTasks.length > 0) {
                showSelectiveRejectDialog(task, childTasks);
            } else {
                // No child tasks, just reset this task
                task.status = 'in-progress';
                task.progress = 50;

                closeTaskModal();
                filterTasks();

                alert(`❌ Đã từ chối phê duyệt!\n\nCông việc "${task.title}" đã được chuyển về trạng thái "Đang thực hiện".`);
            }
        }

        function findCompletedChildTasks(task) {
            const childTasks = [];

            if (task.level === 'task') {
                // Find monthly tasks under this task that are completed (100%)
                const monthlyTasks = sampleTasks.filter(t =>
                    t.level === 'monthly' &&
                    t.code.startsWith(task.code + '_') &&
                    t.progress === 100
                );
                childTasks.push(...monthlyTasks);

                // Find personal tasks under those monthly tasks that are completed (100%)
                monthlyTasks.forEach(monthlyTask => {
                    const personalTasks = sampleTasks.filter(t =>
                        t.level === 'personal' &&
                        t.code.startsWith(monthlyTask.code + '_') &&
                        t.progress === 100
                    );
                    childTasks.push(...personalTasks);
                });

            } else if (task.level === 'monthly') {
                // Find personal tasks under this monthly task that are completed (100%)
                const personalTasks = sampleTasks.filter(t =>
                    t.level === 'personal' &&
                    t.code.startsWith(task.code + '_') &&
                    t.progress === 100
                );
                childTasks.push(...personalTasks);
            }
            // For personal tasks, no child tasks

            return childTasks;
        }

        function showSelectiveRejectDialog(task, childTasks) {
            // Create a simple dialog using prompt for now (can be enhanced with proper modal later)
            let message = `🔍 Chọn các công việc con cần từ chối phê duyệt:\n\n`;
            message += `Công việc cha: ${task.code} - ${task.title}\n\n`;
            message += `Các công việc con đã hoàn thành (100%):\n`;

            childTasks.forEach((childTask, index) => {
                const levelIcon = childTask.level === 'monthly' ? '📅' : '👤';
                message += `${index + 1}. ${levelIcon} ${childTask.code} - ${childTask.monthlyWork || childTask.personalWork || childTask.title}\n`;
            });

            message += `\nNhập số thứ tự các công việc cần từ chối (cách nhau bằng dấu phẩy):\nVí dụ: 1,3,4\n`;
            message += `Để từ chối tất cả, nhập: all\n`;
            message += `Để hủy, nhấn Cancel`;

            const selection = prompt(message);

            if (selection === null) {
                return; // User cancelled
            }

            let selectedTasks = [];

            if (selection.toLowerCase() === 'all') {
                selectedTasks = [...childTasks];
            } else {
                const indices = selection.split(',').map(s => parseInt(s.trim()) - 1);
                selectedTasks = indices
                    .filter(i => i >= 0 && i < childTasks.length)
                    .map(i => childTasks[i]);
            }

            if (selectedTasks.length === 0) {
                alert('Không có công việc nào được chọn.');
                return;
            }

            // Ask for rejection reason
            const reason = prompt(`Nhập lý do từ chối phê duyệt cho ${selectedTasks.length} công việc đã chọn:`);

            if (reason === null || reason.trim() === '') {
                alert('Cần nhập lý do từ chối phê duyệt.');
                return;
            }

            // Apply rejection
            applySelectiveRejection(task, selectedTasks, reason.trim());
        }

        function applySelectiveRejection(parentTask, selectedTasks, reason) {
            // Reset selected child tasks
            selectedTasks.forEach(childTask => {
                if (childTask.level === 'monthly') {
                    childTask.status = 'pending-approval';
                    childTask.progress = 50;
                } else if (childTask.level === 'personal') {
                    childTask.status = 'in-progress';
                    childTask.progress = 50;
                }

                // Add rejection note
                childTask.note = (childTask.note || '') + `\n[${new Date().toLocaleDateString()}] Từ chối phê duyệt: ${reason}`;
            });

            // Recalculate parent task progress
            recalculateParentProgress(parentTask);

            closeTaskModal();
            filterTasks();

            const taskList = selectedTasks.map(t => `• ${t.code}`).join('\n');
            alert(`❌ Đã từ chối phê duyệt!\n\nCác công việc sau đã được reset:\n${taskList}\n\nLý do: ${reason}`);
        }

        function recalculateParentProgress(parentTask) {
            let childTasks = [];

            if (parentTask.level === 'task') {
                // Get all monthly tasks under this task
                childTasks = sampleTasks.filter(t =>
                    t.level === 'monthly' &&
                    t.code.startsWith(parentTask.code + '_')
                );
            } else if (parentTask.level === 'monthly') {
                // Get all personal tasks under this monthly task
                childTasks = sampleTasks.filter(t =>
                    t.level === 'personal' &&
                    t.code.startsWith(parentTask.code + '_')
                );
            }

            if (childTasks.length > 0) {
                const totalProgress = childTasks.reduce((sum, task) => sum + task.progress, 0);
                const averageProgress = Math.round(totalProgress / childTasks.length);

                parentTask.progress = averageProgress;

                // Update status based on new progress
                if (averageProgress === 0) {
                    parentTask.status = 'not-started';
                } else if (averageProgress >= 100) {
                    // Should not happen after rejection, but just in case
                    parentTask.status = parentTask.level === 'monthly' ? 'pending-approval' : 'pending-approval';
                } else {
                    parentTask.status = 'in-progress';
                }

                // Recursively update parent if this task has a parent
                const grandParent = findParentTask(parentTask);
                if (grandParent) {
                    recalculateParentProgress(grandParent);
                }
            }
        }

        function findParentTask(task) {
            const codeParts = task.code.split('_');
            if (codeParts.length <= 2) return null; // No parent (this is a task level)

            const parentCode = codeParts.slice(0, -1).join('_');
            return sampleTasks.find(t => t.code === parentCode);
        }

        // Form section collapse/expand functions
        function toggleSection(headerElement) {
            const content = headerElement.nextElementSibling;
            const icon = headerElement.querySelector('.collapse-icon');

            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                headerElement.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Collapse
                content.classList.add('collapsed');
                headerElement.classList.add('collapsed');
                icon.style.transform = 'rotate(-90deg)';
            }
        }







        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
            resetTaskForm();
            currentEditingTaskId = null;
        }

        function resetTaskForm() {
            try {
                console.log('resetTaskForm called');

                const taskForm = document.getElementById('taskForm');
                if (taskForm) {
                    taskForm.reset();
                } else {
                    console.error('taskForm not found');
                }

                const taskProgress = document.getElementById('taskProgress');
                if (taskProgress) taskProgress.value = 0;

                const taskStatus = document.getElementById('taskStatus');
                if (taskStatus) taskStatus.value = 'not-started';

                const taskCode = document.getElementById('taskCode');
                if (taskCode) {
                    taskCode.value = '';
                    taskCode.readOnly = true;
                }

                // Hide approval section for new tasks
                const approvalSection = document.getElementById('approvalSection');
                if (approvalSection) {
                    approvalSection.style.display = 'none';
                }

                // Auto-select current user as assignee
                const taskAssignee = document.getElementById('taskAssignee');
                if (taskAssignee && typeof currentUser !== 'undefined') {
                    taskAssignee.value = currentUser;
                }

                // If user belongs to only one team, auto-select it
                const taskTeam = document.getElementById('taskTeam');
                if (taskTeam && typeof currentUserTeams !== 'undefined' && currentUserTeams.length === 1) {
                    taskTeam.value = currentUserTeams[0];
                    updateProductOptions();
                }

                updateFormFields();
                console.log('resetTaskForm completed');
            } catch (error) {
                console.error('Error in resetTaskForm:', error);
            }
        }

        // Toast Notification System
        function showToast(title, message, type = 'success', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            toast.innerHTML = `
                <i class="${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="removeToast(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);

            // Auto remove
            setTimeout(() => removeToast(toast), duration);

            return toast;
        }

        function removeToast(toast) {
            if (!toast) return;
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // Loading States
        function showLoading(text = 'Đang xử lý...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // Auto-save functionality
        let autoSaveTimer;
        let formChanged = false;

        function initAutoSave() {
            const formInputs = document.querySelectorAll('#taskForm input, #taskForm select, #taskForm textarea');

            formInputs.forEach(input => {
                input.addEventListener('input', () => {
                    formChanged = true;
                    scheduleAutoSave();
                });

                input.addEventListener('change', () => {
                    formChanged = true;
                    scheduleAutoSave();
                });
            });
        }

        function scheduleAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (formChanged && currentEditingTaskId) {
                    autoSaveDraft();
                }
            }, 2000); // Auto-save after 2 seconds of inactivity
        }

        function autoSaveDraft() {
            if (!currentEditingTaskId) return;

            const formData = {
                taskTitle: document.getElementById('taskTitle').value,
                taskLevel: document.getElementById('taskLevel').value,
                taskTeam: document.getElementById('taskTeam').value,
                taskProduct: document.getElementById('taskProduct').value,
                taskType: document.getElementById('taskType').value,
                taskNature: document.getElementById('taskNature').value,
                taskObjective: document.getElementById('taskObjective').value,
                taskDoD: document.getElementById('taskDoD').value,
                taskAssignee: document.getElementById('taskAssignee').value,
                taskProgress: document.getElementById('taskProgress').value,
                taskPlannedStart: document.getElementById('taskPlannedStart').value,
                taskPlannedEnd: document.getElementById('taskPlannedEnd').value,
                taskActualStart: document.getElementById('taskActualStart').value,
                taskActualEnd: document.getElementById('taskActualEnd').value,
                taskNote: document.getElementById('taskNote').value,
                timestamp: new Date().toISOString()
            };

            localStorage.setItem(`draft_task_${currentEditingTaskId}`, JSON.stringify(formData));

            // Show subtle feedback
            showToast('Tự động lưu', 'Bản nháp đã được lưu', 'info', 2000);
            formChanged = false;
        }

        function loadDraft(taskId) {
            const draftKey = `draft_task_${taskId}`;
            const draft = localStorage.getItem(draftKey);

            if (draft) {
                const formData = JSON.parse(draft);
                const confirmRestore = confirm('Tìm thấy bản nháp đã lưu. Bạn có muốn khôi phục không?');

                if (confirmRestore) {
                    // Restore form data
                    Object.keys(formData).forEach(key => {
                        if (key !== 'timestamp') {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = formData[key];
                            }
                        }
                    });

                    showToast('Khôi phục thành công', 'Bản nháp đã được khôi phục', 'success');
                } else {
                    // Clear draft
                    localStorage.removeItem(draftKey);
                }
            }
        }

        function clearDraft(taskId) {
            if (taskId) {
                localStorage.removeItem(`draft_task_${taskId}`);
            }
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S or Cmd+S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (document.getElementById('taskModal').classList.contains('show')) {
                        saveTask();
                    }
                }

                // Escape to close modal or deselect all
                if (e.key === 'Escape') {
                    if (document.getElementById('taskModal').classList.contains('show')) {
                        closeTaskModal();
                    } else {
                        // If no modal is open, deselect all tasks
                        const selectedTasks = sampleTasks.filter(task => task.selected);
                        if (selectedTasks.length > 0) {
                            e.preventDefault();
                            const selectAllCheckbox = document.getElementById('selectAll');
                            selectAllCheckbox.checked = false;
                            toggleSelectAll();
                        }
                    }
                }



                // F2 to edit selected task (if any)
                if (e.key === 'F2') {
                    e.preventDefault();
                    const selectedCheckbox = document.querySelector('input[type="checkbox"]:checked');
                    if (selectedCheckbox) {
                        const taskId = parseInt(selectedCheckbox.getAttribute('onchange').match(/\d+/)[0]);
                        editTask(taskId);
                    }
                }


            });
        }

        function selectAllTasks() {
            const checkboxes = document.querySelectorAll('#taskTableBody input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
                const taskId = parseInt(checkbox.getAttribute('onchange').match(/\d+/)[0]);
                const task = sampleTasks.find(t => t.id === taskId);
                if (task) {
                    task.selected = checkbox.checked;
                }
            });

            updateSelectAllCheckbox();
            updateBulkActions();
            showToast('Chọn tất cả', `${allChecked ? 'Bỏ chọn' : 'Đã chọn'} tất cả công việc`, 'info', 2000);
        }

        function populateTaskForm(task) {
            document.getElementById('taskLevel').value = task.level || '';
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskTeam').value = task.team || '';
            document.getElementById('taskProduct').value = task.product || '';
            document.getElementById('taskType').value = task.type || '';
            document.getElementById('taskNature').value = task.nature || '';
            document.getElementById('taskObjective').value = task.objective || '';
            document.getElementById('taskDoD').value = task.dod || '';
            document.getElementById('taskAssignee').value = task.assignee || '';
            document.getElementById('taskProgress').value = task.progress || 0;
            document.getElementById('taskStatus').value = task.status || 'not-started';
            document.getElementById('taskPlannedStart').value = task.plannedStartDate || task.startDate || '';
            document.getElementById('taskPlannedEnd').value = task.plannedEndDate || task.dueDate || '';
            document.getElementById('taskActualStart').value = task.actualStartDate || '';
            document.getElementById('taskActualEnd').value = task.actualEndDate || '';
            document.getElementById('taskNote').value = task.note || '';
            document.getElementById('taskCode').value = task.code || '';
            document.getElementById('taskCode').readOnly = !!task.code; // Read-only if editing existing task

            if (task.monthlyWork) {
                document.getElementById('monthlyWork').value = task.monthlyWork;
            }
            if (task.personalWork) {
                document.getElementById('personalWork').value = task.personalWork;
            }

            // Set collaborators (multi-select)
            if (task.collaborators) {
                const collaboratorSelect = document.getElementById('taskCollaborators');
                Array.from(collaboratorSelect.options).forEach(option => {
                    option.selected = task.collaborators.includes(option.value);
                });
            }

            updateFormFields();
            updateProductOptions();
            updateDateFieldsBasedOnLevel();
            updateFormProgress();
        }

        function updateFormFields() {
            const level = document.getElementById('taskLevel').value;
            const monthlyWorkRow = document.getElementById('monthlyWorkRow');
            const parentTaskRow = document.getElementById('parentTaskRow');
            const parentTaskSelect = document.getElementById('taskParent');
            const parentTaskHelp = document.getElementById('parentTaskHelp');
            const userTeamInfo = document.getElementById('userTeamInfo');

            // Show/hide and configure parent task field
            if (level === 'monthly' || level === 'personal') {
                parentTaskRow.style.display = 'block';
                parentTaskSelect.required = true;

                // Update help text based on level
                if (level === 'monthly') {
                    parentTaskHelp.textContent = 'Chọn nhiệm vụ cha để tạo công việc từng tháng';
                } else if (level === 'personal') {
                    parentTaskHelp.textContent = 'Chọn công việc từng tháng để tạo công việc cá nhân';
                }

                // Show user team info
                if (currentUserTeams.length > 0) {
                    userTeamInfo.textContent = `💡 Bạn thuộc: ${currentUserTeams.join(', ')}`;
                } else {
                    userTeamInfo.textContent = '⚠️ Bạn chưa được phân công vào team nào';
                }

                updateParentTaskOptions();
            } else {
                parentTaskRow.style.display = 'none';
                parentTaskSelect.required = false;
                parentTaskSelect.value = '';
            }

            // Show/hide monthly work fields
            if (level === 'monthly' || level === 'personal') {
                monthlyWorkRow.style.display = 'block';

                // Make fields required based on level
                const monthlyWork = document.getElementById('monthlyWork');
                const personalWork = document.getElementById('personalWork');

                if (level === 'monthly') {
                    monthlyWork.required = true;
                    personalWork.required = false;
                } else if (level === 'personal') {
                    monthlyWork.required = true;
                    personalWork.required = true;
                }
            } else {
                monthlyWorkRow.style.display = 'none';
                document.getElementById('monthlyWork').required = false;
                document.getElementById('personalWork').required = false;
            }
        }

        function updateProductOptions() {
            const team = document.getElementById('taskTeam').value;
            const productSelect = document.getElementById('taskProduct');

            // Clear existing options
            productSelect.innerHTML = '<option value="">Chọn sản phẩm/dịch vụ</option>';

            // Product/Service mapping by team
            const productsByTeam = {
                'Team 1 - Public Cloud Vmware': ['VMware vSphere', 'vSAN Storage', 'NSX Network', 'vRealize Suite'],
                'Team 2 - Public Cloud OpenStack': ['OpenStack Cloud', 'Ceph Storage', 'Neutron Network', 'Heat Orchestration'],
                'Team 3 - Private Cloud': ['Private Cloud Platform', 'Hybrid Cloud', 'Cloud Templates', 'Migration Services'],
                'Team 4 - Backup & DR': ['Backup Solutions', 'Disaster Recovery', 'Data Protection', 'Archive Services'],
                'Team 5 - Network & Security': ['Firewall Services', 'VPN Solutions', 'Network Monitoring', 'Security Audit'],
                'Team 6 - DevOps': ['CI/CD Pipeline', 'Container Platform', 'Automation Tools', 'Monitoring Stack'],
                'Team 7 - Monitoring': ['System Monitoring', 'Application Monitoring', 'Log Management', 'Alerting System'],
                'Team 8 - DB': ['Database Services', 'Data Warehouse', 'Database Backup', 'Performance Tuning'],
                'Team 9 - Middleware': ['Application Server', 'Message Queue', 'API Gateway', 'Service Mesh'],
                'Team 10 - Container': ['Kubernetes Platform', 'Docker Registry', 'Container Security', 'Orchestration'],
                'Team 11 - ATM': ['ATM Network', 'Transaction Processing', 'ATM Monitoring', 'Cash Management'],
                'Team 12 - Core Banking': ['Core Banking System', 'Payment Processing', 'Account Management', 'Risk Management'],
                'Team 13 - Digital Banking': ['Mobile Banking', 'Internet Banking', 'Digital Wallet', 'API Banking'],
                'Team 14 - Management': ['Project Management', 'Resource Planning', 'Quality Assurance', 'Training Programs']
            };

            if (team && productsByTeam[team]) {
                productsByTeam[team].forEach(product => {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                });
            }
        }

        function updateParentTaskOptions() {
            const level = document.getElementById('taskLevel').value;
            const parentSelect = document.getElementById('taskParent');

            // Clear existing options
            parentSelect.innerHTML = '<option value="">Chọn công việc cha</option>';

            if (level === 'monthly') {
                // For monthly tasks, show task-level items grouped by team
                const taskLevelItems = sampleTasks.filter(t =>
                    t.level === 'task' && currentUserTeams.includes(t.team)
                );

                if (taskLevelItems.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Không có nhiệm vụ cha phù hợp';
                    option.disabled = true;
                    parentSelect.appendChild(option);
                    return;
                }

                // Group by team
                const tasksByTeam = {};
                taskLevelItems.forEach(task => {
                    if (!tasksByTeam[task.team]) {
                        tasksByTeam[task.team] = [];
                    }
                    tasksByTeam[task.team].push(task);
                });

                // Add options grouped by team
                Object.keys(tasksByTeam).sort().forEach(teamName => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `📋 ${teamName}`;
                    parentSelect.appendChild(optgroup);

                    tasksByTeam[teamName].forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.code;
                        const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '🔄' : '⏸️';
                        option.textContent = `${task.code} - ${task.title} (${task.progress}% ${statusIcon})`;
                        optgroup.appendChild(option);
                    });
                });

            } else if (level === 'personal') {
                // For personal tasks, show monthly-level items grouped by team -> task -> monthly
                const monthlyLevelItems = sampleTasks.filter(t =>
                    t.level === 'monthly' && currentUserTeams.includes(t.team)
                );

                if (monthlyLevelItems.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Không có công việc tháng cha phù hợp';
                    option.disabled = true;
                    parentSelect.appendChild(option);
                    return;
                }

                // Group by team first, then by parent task
                const hierarchy = {};
                monthlyLevelItems.forEach(monthlyTask => {
                    // Find parent task
                    const parentTaskCode = monthlyTask.code.split('_').slice(0, 2).join('_'); // PC1_004 from PC1_004_001
                    const parentTask = sampleTasks.find(t => t.code === parentTaskCode);

                    if (!hierarchy[monthlyTask.team]) {
                        hierarchy[monthlyTask.team] = {};
                    }

                    const parentTitle = parentTask ? parentTask.title : 'Unknown Task';
                    const parentKey = `${parentTaskCode} - ${parentTitle}`;

                    if (!hierarchy[monthlyTask.team][parentKey]) {
                        hierarchy[monthlyTask.team][parentKey] = [];
                    }

                    hierarchy[monthlyTask.team][parentKey].push(monthlyTask);
                });

                // Build hierarchical options
                Object.keys(hierarchy).sort().forEach(teamName => {
                    const teamOptgroup = document.createElement('optgroup');
                    teamOptgroup.label = `📋 ${teamName}`;
                    parentSelect.appendChild(teamOptgroup);

                    Object.keys(hierarchy[teamName]).sort().forEach(parentTaskKey => {
                        // Add parent task as a sub-header (disabled option)
                        const parentHeader = document.createElement('option');
                        parentHeader.value = '';
                        parentHeader.textContent = `  └── 📝 ${parentTaskKey}`;
                        parentHeader.disabled = true;
                        parentHeader.style.fontStyle = 'italic';
                        parentHeader.style.color = '#888';
                        teamOptgroup.appendChild(parentHeader);

                        // Add monthly tasks under this parent
                        hierarchy[teamName][parentTaskKey].forEach(monthlyTask => {
                            const option = document.createElement('option');
                            option.value = monthlyTask.code;
                            option.textContent = `      ├─ ${monthlyTask.code} - ${monthlyTask.monthlyWork || monthlyTask.title}`;
                            teamOptgroup.appendChild(option);
                        });
                    });
                });
            }
        }

        function validateTaskDates() {
            const plannedStart = document.getElementById('taskPlannedStart').value;
            const plannedEnd = document.getElementById('taskPlannedEnd').value;
            const actualStart = document.getElementById('taskActualStart').value;
            const actualEnd = document.getElementById('taskActualEnd').value;

            // Validate planned dates
            if (plannedStart && plannedEnd) {
                if (new Date(plannedStart) > new Date(plannedEnd)) {
                    showToast('Lỗi ngày tháng', 'Ngày hoàn thành kế hoạch phải sau ngày bắt đầu kế hoạch', 'error');
                    document.getElementById('taskPlannedEnd').focus();
                    return false;
                }
            }

            // Validate actual dates
            if (actualStart && actualEnd) {
                if (new Date(actualStart) > new Date(actualEnd)) {
                    showToast('Lỗi ngày tháng', 'Ngày kết thúc thực tế phải sau ngày bắt đầu thực tế', 'error');
                    document.getElementById('taskActualEnd').focus();
                    return false;
                }
            }

            // Validate actual vs planned dates
            if (plannedStart && actualStart) {
                const plannedStartDate = new Date(plannedStart);
                const actualStartDate = new Date(actualStart);
                const daysDiff = Math.ceil((actualStartDate - plannedStartDate) / (1000 * 60 * 60 * 24));

                if (daysDiff > 3) {
                    const confirmMsg = `Ngày bắt đầu thực tế chậm ${daysDiff} ngày so với kế hoạch. Bạn có muốn tiếp tục?`;
                    if (!confirm(confirmMsg)) {
                        document.getElementById('taskActualStart').focus();
                        return false;
                    }
                }
            }

            if (plannedEnd && actualEnd) {
                const plannedEndDate = new Date(plannedEnd);
                const actualEndDate = new Date(actualEnd);
                const daysDiff = Math.ceil((actualEndDate - plannedEndDate) / (1000 * 60 * 60 * 24));

                if (daysDiff > 3) {
                    const confirmMsg = `Ngày kết thúc thực tế chậm ${daysDiff} ngày so với kế hoạch. Bạn có muốn tiếp tục?`;
                    if (!confirm(confirmMsg)) {
                        document.getElementById('taskActualEnd').focus();
                        return false;
                    }
                }
            }

            return true;
        }

        function calculateParentDates(parentTask) {
            // Find all children tasks
            const children = sampleTasks.filter(task => {
                if (parentTask.level === 'task') {
                    return task.level === 'monthly' && task.parent === parentTask.code;
                } else if (parentTask.level === 'monthly') {
                    return task.level === 'personal' && task.parent === parentTask.code;
                }
                return false;
            });

            if (children.length === 0) return;

            // Calculate actual start date (earliest child actual start)
            const actualStartDates = children
                .map(child => child.actualStartDate)
                .filter(date => date)
                .map(date => new Date(date));

            if (actualStartDates.length > 0) {
                const earliestStart = new Date(Math.min(...actualStartDates));
                parentTask.actualStartDate = earliestStart.toISOString().split('T')[0];
            }

            // Calculate actual end date (latest child actual end, only if all children completed)
            const actualEndDates = children
                .map(child => child.actualEndDate)
                .filter(date => date)
                .map(date => new Date(date));

            if (actualEndDates.length === children.length && actualEndDates.length > 0) {
                // All children have actual end dates
                const latestEnd = new Date(Math.max(...actualEndDates));
                parentTask.actualEndDate = latestEnd.toISOString().split('T')[0];
            }

            // Calculate planned dates (earliest planned start, latest planned end)
            const plannedStartDates = children
                .map(child => child.plannedStartDate)
                .filter(date => date)
                .map(date => new Date(date));

            if (plannedStartDates.length > 0) {
                const earliestPlannedStart = new Date(Math.min(...plannedStartDates));
                if (!parentTask.plannedStartDate) {
                    parentTask.plannedStartDate = earliestPlannedStart.toISOString().split('T')[0];
                }
            }

            const plannedEndDates = children
                .map(child => child.plannedEndDate)
                .filter(date => date)
                .map(date => new Date(date));

            if (plannedEndDates.length > 0) {
                const latestPlannedEnd = new Date(Math.max(...plannedEndDates));
                if (!parentTask.plannedEndDate) {
                    parentTask.plannedEndDate = latestPlannedEnd.toISOString().split('T')[0];
                }
            }

            // Update legacy fields for compatibility
            parentTask.startDate = parentTask.plannedStartDate || parentTask.actualStartDate;
            parentTask.dueDate = parentTask.plannedEndDate || parentTask.actualEndDate;

            // Check for delays and show warnings for main tasks
            checkParentTaskDelays(parentTask);
        }

        function checkParentTaskDelays(parentTask) {
            // Only check delays for tasks that have both planned and actual dates
            if (!parentTask.plannedStartDate || !parentTask.actualStartDate) return;
            if (!parentTask.plannedEndDate || !parentTask.actualEndDate) return;

            const plannedStart = new Date(parentTask.plannedStartDate);
            const actualStart = new Date(parentTask.actualStartDate);
            const plannedEnd = new Date(parentTask.plannedEndDate);
            const actualEnd = new Date(parentTask.actualEndDate);

            const startDelay = Math.ceil((actualStart - plannedStart) / (1000 * 60 * 60 * 24));
            const endDelay = Math.ceil((actualEnd - plannedEnd) / (1000 * 60 * 60 * 24));

            let warningMessage = '';

            if (startDelay > 3) {
                warningMessage += `⚠️ Bắt đầu chậm ${startDelay} ngày. `;
            }

            if (endDelay > 3) {
                warningMessage += `⚠️ Hoàn thành chậm ${endDelay} ngày. `;
            }

            if (warningMessage) {
                const taskLevel = parentTask.level === 'task' ? 'Nhiệm vụ' : 'Công việc từng tháng';
                const fullMessage = `${taskLevel} "${parentTask.title}" (${parentTask.code}): ${warningMessage}`;

                // Store warning in task object for display
                parentTask.delayWarning = warningMessage.trim();

                // Show toast notification
                showToast('Cảnh báo chậm tiến độ', fullMessage, 'warning', 5000);

                console.warn('Task Delay Warning:', {
                    task: parentTask.code,
                    title: parentTask.title,
                    level: parentTask.level,
                    startDelay: startDelay,
                    endDelay: endDelay,
                    plannedStart: parentTask.plannedStartDate,
                    actualStart: parentTask.actualStartDate,
                    plannedEnd: parentTask.plannedEndDate,
                    actualEnd: parentTask.actualEndDate
                });
            } else {
                // Clear any existing warning
                delete parentTask.delayWarning;
            }
        }

        function updateParentTaskDates(childTask) {
            // Find parent task and update its dates
            if (childTask.parent) {
                const parentTask = sampleTasks.find(task => task.code === childTask.parent);
                if (parentTask) {
                    calculateParentDates(parentTask);

                    // If parent has a parent (task level), update that too
                    if (parentTask.parent) {
                        const grandParentTask = sampleTasks.find(task => task.code === parentTask.parent);
                        if (grandParentTask) {
                            calculateParentDates(grandParentTask);
                        }
                    }
                }
            }
        }

        function checkAllTaskDelays() {
            // Check delays for all parent tasks (task and monthly levels)
            const parentTasks = sampleTasks.filter(task =>
                task.level === 'task' || task.level === 'monthly'
            );

            parentTasks.forEach(task => {
                if (task.plannedStartDate && task.actualStartDate &&
                    task.plannedEndDate && task.actualEndDate) {
                    checkParentTaskDelays(task);
                }
            });
        }



        function calculateParentProgress(parentTask) {
            // Find all direct children tasks
            const children = sampleTasks.filter(task => {
                if (parentTask.level === 'task') {
                    // For main tasks, find monthly tasks with matching parent code
                    return task.level === 'monthly' && task.parent === parentTask.code;
                } else if (parentTask.level === 'monthly') {
                    // For monthly tasks, find personal tasks with matching parent code
                    return task.level === 'personal' && task.parent === parentTask.code;
                }
                return false;
            });

            if (children.length === 0) {
                // No children, keep current progress
                return parentTask.progress || 0;
            }

            // Calculate average progress of children
            const totalProgress = children.reduce((sum, child) => sum + (child.progress || 0), 0);
            const averageProgress = Math.round(totalProgress / children.length);

            return averageProgress;
        }

        function updateParentProgress(childTask) {
            // Find parent task and update its progress
            if (childTask.parent) {
                const parentTask = sampleTasks.find(task => task.code === childTask.parent);
                if (parentTask) {
                    const newProgress = calculateParentProgress(parentTask);
                    parentTask.progress = newProgress;

                    // Update parent status based on new progress
                    if (newProgress === 0) {
                        parentTask.status = 'not-started';
                    } else if (newProgress >= 100) {
                        // Apply approval workflow based on task level
                        if (parentTask.level === 'monthly') {
                            parentTask.status = 'pending-approval'; // CPO approval needed
                        } else {
                            parentTask.status = 'completed'; // Task level auto-complete
                        }
                    } else {
                        parentTask.status = 'in-progress';
                    }

                    // If parent has a parent (task level), update that too
                    if (parentTask.parent) {
                        const grandParentTask = sampleTasks.find(task => task.code === parentTask.parent);
                        if (grandParentTask) {
                            const grandParentProgress = calculateParentProgress(grandParentTask);
                            grandParentTask.progress = grandParentProgress;

                            // Update grandparent status
                            if (grandParentProgress === 0) {
                                grandParentTask.status = 'not-started';
                            } else if (grandParentProgress >= 100) {
                                grandParentTask.status = 'completed'; // Task level auto-complete
                            } else {
                                grandParentTask.status = 'in-progress';
                            }
                        }
                    }
                }
            }
        }

        function validateParentChildRelationship(taskData) {
            // Validate parent-child relationship rules
            const level = taskData.level;
            const parentCode = taskData.parent;

            if (level === 'monthly') {
                // Monthly tasks must have a task-level parent
                if (!parentCode) {
                    showToast('Lỗi phụ thuộc', 'Công việc từng tháng phải có nhiệm vụ cha', 'error');
                    return false;
                }

                const parentTask = sampleTasks.find(t => t.code === parentCode);
                if (!parentTask) {
                    showToast('Lỗi phụ thuộc', 'Không tìm thấy nhiệm vụ cha', 'error');
                    return false;
                }

                if (parentTask.level !== 'task') {
                    showToast('Lỗi phụ thuộc', 'Công việc từng tháng chỉ có thể thuộc về nhiệm vụ chính', 'error');
                    return false;
                }

                // Check team consistency
                if (parentTask.team !== taskData.team) {
                    showToast('Lỗi phụ thuộc', 'Team của công việc con phải giống team của nhiệm vụ cha', 'error');
                    return false;
                }

            } else if (level === 'personal') {
                // Personal tasks must have a monthly-level parent
                if (!parentCode) {
                    showToast('Lỗi phụ thuộc', 'Công việc cá nhân phải có công việc tháng cha', 'error');
                    return false;
                }

                const parentTask = sampleTasks.find(t => t.code === parentCode);
                if (!parentTask) {
                    showToast('Lỗi phụ thuộc', 'Không tìm thấy công việc tháng cha', 'error');
                    return false;
                }

                if (parentTask.level !== 'monthly') {
                    showToast('Lỗi phụ thuộc', 'Công việc cá nhân chỉ có thể thuộc về công việc từng tháng', 'error');
                    return false;
                }

                // Check team consistency
                if (parentTask.team !== taskData.team) {
                    showToast('Lỗi phụ thuộc', 'Team của công việc con phải giống team của công việc cha', 'error');
                    return false;
                }

            } else if (level === 'task') {
                // Task-level items should not have parents
                if (parentCode) {
                    showToast('Lỗi phụ thuộc', 'Nhiệm vụ chính không thể có công việc cha', 'error');
                    return false;
                }
            }

            return true;
        }

        function validateTaskCodeUniqueness(taskCode, excludeTaskId = null) {
            // Check if task code already exists
            const existingTask = sampleTasks.find(t =>
                t.code === taskCode && t.id !== excludeTaskId
            );

            if (existingTask) {
                showToast('Lỗi mã công việc', `Mã công việc "${taskCode}" đã tồn tại`, 'error');
                return false;
            }

            return true;
        }

        function saveTask() {
            const form = document.getElementById('taskForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                showToast('Lỗi validation', 'Vui lòng kiểm tra lại thông tin đã nhập', 'error');
                return;
            }

            // Validate dates
            if (!validateTaskDates()) {
                return;
            }

            const taskCode = document.getElementById('taskCode').value;

            // Validate task code format and uniqueness
            if (!taskCode) {
                showToast('Thiếu mã công việc', 'Vui lòng tạo mã công việc trước khi lưu', 'warning');
                return;
            }

            if (!validateTaskCode(taskCode)) {
                return;
            }

            // Validate task code uniqueness
            if (!validateTaskCodeUniqueness(taskCode, currentEditingTaskId)) {
                return;
            }

            // Show loading
            const saveButton = document.querySelector('.modal-footer .btn-primary');
            setButtonLoading(saveButton, true);
            showLoading('Đang lưu công việc...');

            // Get collaborators (multi-select)
            const collaboratorSelect = document.getElementById('taskCollaborators');
            const collaborators = Array.from(collaboratorSelect.selectedOptions).map(option => option.value);

            const taskData = {
                code: taskCode,
                title: document.getElementById('taskTitle').value,
                level: document.getElementById('taskLevel').value,
                team: document.getElementById('taskTeam').value,
                product: document.getElementById('taskProduct').value,
                type: document.getElementById('taskType').value,
                nature: document.getElementById('taskNature').value,
                objective: document.getElementById('taskObjective').value,
                parent: document.getElementById('taskParent').value,
                dod: document.getElementById('taskDoD').value,
                assignee: document.getElementById('taskAssignee').value,
                collaborators: collaborators,
                plannedStartDate: document.getElementById('taskPlannedStart').value,
                plannedEndDate: document.getElementById('taskPlannedEnd').value,
                actualStartDate: document.getElementById('taskActualStart').value,
                actualEndDate: document.getElementById('taskActualEnd').value,
                progress: parseInt(document.getElementById('taskProgress').value) || 0,
                status: document.getElementById('taskStatus').value,
                note: document.getElementById('taskNote').value,
                monthlyWork: document.getElementById('monthlyWork').value || '',
                personalWork: document.getElementById('personalWork').value || '',
                dueDate: document.getElementById('taskPlannedEnd').value, // Use planned end as due date
                selected: false
            };

            // Validate parent-child relationship
            if (!validateParentChildRelationship(taskData)) {
                // Hide loading and reset button
                hideLoading();
                setButtonLoading(saveButton, false);
                return;
            }

            // Auto-update status based on progress and approval workflow
            if (taskData.progress === 0) {
                taskData.status = 'not-started';
            } else if (taskData.progress >= 100) {
                // Apply approval workflow based on task level
                if (taskData.level === 'personal') {
                    taskData.status = 'pending-approval'; // PM/PO approval needed
                } else if (taskData.level === 'monthly') {
                    taskData.status = 'pending-approval'; // CPO approval needed
                } else {
                    taskData.status = 'completed'; // Task level auto-complete
                }
            } else {
                taskData.status = 'in-progress';
            }

            if (currentEditingTaskId) {
                // Update existing task
                const taskIndex = sampleTasks.findIndex(t => t.id === currentEditingTaskId);
                if (taskIndex !== -1) {
                    sampleTasks[taskIndex] = { ...sampleTasks[taskIndex], ...taskData };

                    // Update parent task dates and progress if this is a child task
                    updateParentTaskDates(sampleTasks[taskIndex]);
                    updateParentProgress(sampleTasks[taskIndex]);
                }
            } else {
                // Add new task
                const newId = Math.max(...sampleTasks.map(t => t.id)) + 1;
                const newTask = { id: newId, ...taskData };
                sampleTasks.push(newTask);

                // Update parent task dates and progress if this is a child task
                updateParentTaskDates(newTask);
                updateParentProgress(newTask);
            }

            // Simulate async operation
            setTimeout(() => {
                // Refresh the table
                filterTasks();

                // Clear draft
                clearDraft(currentEditingTaskId);

                // Hide loading
                hideLoading();
                setButtonLoading(saveButton, false);

                closeTaskModal();

                // Show success message
                const action = currentEditingTaskId ? 'cập nhật' : 'thêm';
                showToast('Thành công!', `Đã ${action} công việc thành công`, 'success');
            }, 800); // Simulate network delay
        }

        function toggleFormSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');

            if (content.classList.contains('collapsed')) {
                // Expand section
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                toggle.classList.remove('collapsed');
            } else {
                // Collapse section
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }

        function updateFormProgress() {
            // Calculate form completion progress
            const requiredFields = [
                'taskLevel', 'taskTitle', 'taskTeam', 'taskDoD',
                'taskAssignee', 'taskPlannedStart', 'taskPlannedEnd'
            ];

            // Add conditional required fields
            const level = document.getElementById('taskLevel').value;
            if (level === 'monthly' || level === 'personal') {
                requiredFields.push('taskParent');
            }
            // Note: monthlyWork and personalWork are no longer required

            let filledFields = 0;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value && field.value.trim() !== '') {
                    filledFields++;
                }
            });

            const progressPercent = Math.round((filledFields / requiredFields.length) * 100);

            // Update progress bar
            const progressFill = document.getElementById('formProgressFill');
            const progressText = document.getElementById('formProgressText');

            if (progressFill) {
                progressFill.style.width = progressPercent + '%';
            }

            if (progressText) {
                progressText.textContent = `${filledFields}/${requiredFields.length} trường bắt buộc đã điền (${progressPercent}%)`;
            }

            // Change color based on progress
            if (progressFill) {
                if (progressPercent < 50) {
                    progressFill.style.background = 'linear-gradient(90deg, #dc3545, #fd7e14)';
                } else if (progressPercent < 80) {
                    progressFill.style.background = 'linear-gradient(90deg, #fd7e14, #ffc107)';
                } else {
                    progressFill.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
                }
            }
        }

        function setFormSectionsForAdd() {
            // For new tasks, expand ALL sections including advanced
            const sections = ['basicInfo', 'workDetails', 'assignment', 'schedule', 'progress', 'advanced'];

            sections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                const toggle = document.getElementById(sectionId + '-toggle');
                if (content && toggle) {
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                    toggle.classList.remove('collapsed');
                }
            });

            // Initialize form progress
            updateFormProgress();
        }

        function setFormSectionsForEdit() {
            // For editing, expand essential sections for quick editing
            const expandedSections = ['basicInfo', 'schedule', 'progress'];
            const collapsedSections = ['workDetails', 'assignment', 'advanced'];

            expandedSections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                const toggle = document.getElementById(sectionId + '-toggle');
                if (content && toggle) {
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                    toggle.classList.remove('collapsed');
                }
            });

            collapsedSections.forEach(sectionId => {
                const content = document.getElementById(sectionId + '-content');
                const toggle = document.getElementById(sectionId + '-toggle');
                if (content && toggle) {
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                }
            });

            // Update form progress
            updateFormProgress();
        }

        function updateDateFieldsBasedOnLevel() {
            const level = document.getElementById('taskLevel').value;
            const actualStartField = document.getElementById('taskActualStart');
            const actualEndField = document.getElementById('taskActualEnd');
            const actualStartHelp = document.getElementById('actualStartHelp');
            const actualEndHelp = document.getElementById('actualEndHelp');

            // For parent tasks (task and monthly level), actual dates are auto-calculated
            if (level === 'task' || level === 'monthly') {
                actualStartField.disabled = true;
                actualEndField.disabled = true;
                actualStartField.title = 'Ngày này được tự động tính từ các công việc con';
                actualEndField.title = 'Ngày này được tự động tính từ các công việc con';

                // Add visual indicator
                actualStartField.style.backgroundColor = '#f8f9fa';
                actualEndField.style.backgroundColor = '#f8f9fa';

                // Update helper text
                if (actualStartHelp) {
                    actualStartHelp.innerHTML = '🔄 Tự động tính từ công việc con (không thể chỉnh sửa)';
                    actualStartHelp.style.color = '#6c757d';
                }
                if (actualEndHelp) {
                    actualEndHelp.innerHTML = '🔄 Tự động tính từ công việc con (không thể chỉnh sửa)';
                    actualEndHelp.style.color = '#6c757d';
                }
            } else {
                // Personal level tasks can have manual actual dates
                actualStartField.disabled = false;
                actualEndField.disabled = false;
                actualStartField.title = '';
                actualEndField.title = '';
                actualStartField.style.backgroundColor = '';
                actualEndField.style.backgroundColor = '';

                // Update helper text
                if (actualStartHelp) {
                    actualStartHelp.innerHTML = 'Nhập ngày bắt đầu thực tế của công việc (cảnh báo nếu chậm > 3 ngày)';
                    actualStartHelp.style.color = '#6c757d';
                }
                if (actualEndHelp) {
                    actualEndHelp.innerHTML = 'Nhập ngày kết thúc thực tế của công việc (cảnh báo nếu chậm > 3 ngày)';
                    actualEndHelp.style.color = '#6c757d';
                }
            }
        }

        function setupModalEventListeners() {
            const modal = document.getElementById('taskModal');

            // Close modal when clicking outside
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeTaskModal();
                }
            });

            // Close modal with ESC key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && modal.classList.contains('show')) {
                    closeTaskModal();
                }
            });

            // Handle task level changes
            document.getElementById('taskLevel').addEventListener('change', function() {
                updateDateFieldsBasedOnLevel();
            });

            // Auto-update status when progress changes
            document.getElementById('taskProgress').addEventListener('input', function() {
                const progress = parseInt(this.value) || 0;
                const level = document.getElementById('taskLevel').value;
                const statusSelect = document.getElementById('taskStatus');
                const statusHelp = document.getElementById('statusHelp');

                if (progress === 0) {
                    statusSelect.value = 'not-started';
                    statusHelp.textContent = 'Tự động cập nhật theo tiến độ';
                } else if (progress >= 100) {
                    // Apply approval workflow based on task level
                    if (level === 'personal') {
                        statusSelect.value = 'pending-approval';
                        statusHelp.textContent = 'Cần phê duyệt từ PM/PO khi đạt 100%';
                    } else if (level === 'monthly') {
                        statusSelect.value = 'pending-approval';
                        statusHelp.textContent = 'Cần phê duyệt từ CPO khi đạt 100%';
                    } else {
                        // Task level - auto complete
                        statusSelect.value = 'completed';
                        statusHelp.textContent = 'Nhiệm vụ tự động hoàn thành khi đạt 100%';
                    }
                } else {
                    statusSelect.value = 'in-progress';
                    statusHelp.textContent = 'Tự động cập nhật theo tiến độ';
                }
            });
        }

        function validateTaskCode(code) {
            // Check if code already exists (except for current editing task)
            const existingTask = sampleTasks.find(t => t.code === code && t.id !== currentEditingTaskId);
            if (existingTask) {
                alert('Mã công việc đã tồn tại. Vui lòng chọn mã khác.');
                document.getElementById('taskCode').focus();
                return false;
            }

            // Validate code format based on level
            const level = document.getElementById('taskLevel').value;
            const codePattern = {
                'task': /^[A-Z]{2,3}\d+_\d{3}$/,           // PC1_001
                'monthly': /^[A-Z]{2,3}\d+_\d{3}_\d{3}$/,  // PC1_001_001
                'personal': /^[A-Z]{2,3}\d+_\d{3}_\d{3}_\d{3}$/ // PC1_001_001_001
            };

            if (level && codePattern[level] && !codePattern[level].test(code)) {
                const examples = {
                    'task': 'PC1_001',
                    'monthly': 'PC1_001_001',
                    'personal': 'PC1_001_001_001'
                };
                alert(`Mã công việc không đúng định dạng cho cấp độ "${level}". Ví dụ: ${examples[level]}`);
                document.getElementById('taskCode').focus();
                return false;
            }

            return true;
        }

        function generateTaskCode() {
            const team = document.getElementById('taskTeam').value;
            const level = document.getElementById('taskLevel').value;
            const title = document.getElementById('taskTitle').value;
            const parentCode = document.getElementById('taskParent').value;

            if (!level || !title) {
                alert('Vui lòng điền đầy đủ Cấp độ và Tên nhiệm vụ trước khi tạo mã');
                return;
            }

            // For monthly/personal tasks, parent is required
            if ((level === 'monthly' || level === 'personal') && !parentCode) {
                alert('Vui lòng chọn công việc cha trước khi tạo mã');
                return;
            }

            // For task level, team is required
            if (level === 'task' && !team) {
                alert('Vui lòng chọn Team trước khi tạo mã');
                return;
            }

            // Extract team prefix (PC1, PC2, etc.)
            const teamMatch = team.match(/Team (\d+)/);
            if (!teamMatch) return;

            const teamNumber = teamMatch[1];
            let prefix = '';

            // Map team to prefix based on team structure
            if (teamNumber <= 5) {
                prefix = 'PC' + teamNumber; // IaaS teams
            } else if (teamNumber <= 10) {
                prefix = 'PA' + (teamNumber - 5); // PaaS teams
            } else if (teamNumber <= 13) {
                prefix = 'SW' + (teamNumber - 10); // Software teams
            } else {
                prefix = 'MG1'; // Management team
            }

            // Find next available number for this prefix and level
            const existingCodes = sampleTasks
                .filter(t => t.code && t.code.startsWith(prefix))
                .map(t => t.code);

            let nextNumber = 1;
            let newCode = '';

            if (level === 'task') {
                // Find next task number: PC1_001, PC1_002, etc.
                while (existingCodes.includes(`${prefix}_${String(nextNumber).padStart(3, '0')}`)) {
                    nextNumber++;
                }
                newCode = `${prefix}_${String(nextNumber).padStart(3, '0')}`;
            } else if (level === 'monthly') {
                // For monthly work, use parent task from dropdown
                const parentCode = document.getElementById('taskParent').value;
                if (!parentCode) {
                    alert('Vui lòng chọn công việc cha trước khi tạo mã');
                    return;
                }

                nextNumber = 1;
                while (existingCodes.includes(`${parentCode}_${String(nextNumber).padStart(3, '0')}`)) {
                    nextNumber++;
                }
                newCode = `${parentCode}_${String(nextNumber).padStart(3, '0')}`;
            } else if (level === 'personal') {
                // For personal work, use parent monthly code from dropdown
                const parentCode = document.getElementById('taskParent').value;
                if (!parentCode) {
                    alert('Vui lòng chọn công việc cha trước khi tạo mã');
                    return;
                }

                nextNumber = 1;
                while (existingCodes.includes(`${parentCode}_${String(nextNumber).padStart(3, '0')}`)) {
                    nextNumber++;
                }
                newCode = `${parentCode}_${String(nextNumber).padStart(3, '0')}`;
            }

            document.getElementById('taskCode').value = newCode;
            document.getElementById('taskCode').readOnly = true;
        }

        function onParentTaskChange() {
            const parentCode = document.getElementById('taskParent').value;
            if (!parentCode) return;

            // Find parent task
            const parentTask = sampleTasks.find(t => t.code === parentCode);
            if (!parentTask) return;

            // Auto-fill team from parent task
            document.getElementById('taskTeam').value = parentTask.team;

            // Auto-fill product if parent has one
            if (parentTask.product) {
                updateProductOptions();
                document.getElementById('taskProduct').value = parentTask.product;
            } else {
                updateProductOptions();
            }

            // Auto-fill type and nature from parent
            if (parentTask.type) {
                document.getElementById('taskType').value = parentTask.type;
            }
            if (parentTask.nature) {
                document.getElementById('taskNature').value = parentTask.nature;
            }

            // For monthly tasks, inherit title from parent task
            const level = document.getElementById('taskLevel').value;
            if (level === 'monthly' && !document.getElementById('taskTitle').value) {
                document.getElementById('taskTitle').value = parentTask.title;
            }
            // For personal tasks, inherit title from parent monthly work
            else if (level === 'personal' && !document.getElementById('taskTitle').value) {
                document.getElementById('taskTitle').value = parentTask.title;
            }
        }

        // Excel column mapping - with 4 date fields
        const EXCEL_COLUMNS = [
            'STT',
            'Mã công việc',
            'Team chủ trì',
            'Tên sản phẩm/dịch vụ',
            'Loại công việc',
            'Tính chất công việc',
            'Nhiệm vụ',
            'Công việc từng tháng',
            'Công việc cá nhân tháng',
            'Mục tiêu',
            'DoD (Definition of Done)',
            'Người phụ trách',
            'Team/Người phối hợp',
            'Ngày bắt đầu kế hoạch',
            'Ngày hoàn thành kế hoạch',
            'Ngày bắt đầu thực tế',
            'Ngày kết thúc thực tế',
            'Tiến độ (%)',
            'Trạng thái',
            'Ghi chú'
        ];

        function exportTasks() {
            showLoading('Đang xuất Excel...');

            try {
                // Prepare data for export
                const exportData = filteredTasks.map((task, index) => {
                    return {
                        'STT': index + 1,
                        'Mã công việc': task.code || '',
                        'Team chủ trì': task.team || '',
                        'Tên sản phẩm/dịch vụ': task.product || '',
                        'Loại công việc': task.type || '',
                        'Tính chất công việc': task.nature || '',
                        'Nhiệm vụ': task.level === 'task' ? task.title : '',
                        'Công việc từng tháng': task.monthlyWork || '',
                        'Công việc cá nhân tháng': task.personalWork || '',
                        'Mục tiêu': task.objective || '',
                        'DoD (Definition of Done)': task.dod || '',
                        'Người phụ trách': task.assignee || '',
                        'Team/Người phối hợp': task.collaborators ? task.collaborators.join(', ') : '',
                        'Ngày bắt đầu kế hoạch': task.plannedStartDate || task.startDate || '',
                        'Ngày hoàn thành kế hoạch': task.plannedEndDate || task.dueDate || '',
                        'Ngày bắt đầu thực tế': task.actualStartDate || '',
                        'Ngày kết thúc thực tế': task.actualEndDate || '',
                        'Tiến độ (%)': task.progress || 0,
                        'Trạng thái': getStatusText(task.status),
                        'Ghi chú': task.notes || ''
                    };
                });

                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Set column widths
                const colWidths = [
                    {wch: 5},   // STT
                    {wch: 15},  // Mã công việc
                    {wch: 30},  // Team chủ trì
                    {wch: 20},  // Tên sản phẩm/dịch vụ
                    {wch: 18},  // Loại công việc
                    {wch: 18},  // Tính chất công việc
                    {wch: 30},  // Nhiệm vụ
                    {wch: 30},  // Công việc từng tháng
                    {wch: 30},  // Công việc cá nhân tháng
                    {wch: 25},  // Mục tiêu
                    {wch: 30},  // DoD
                    {wch: 20},  // Người phụ trách
                    {wch: 25},  // Team/Người phối hợp
                    {wch: 18},  // Ngày bắt đầu kế hoạch
                    {wch: 18},  // Ngày hoàn thành kế hoạch
                    {wch: 18},  // Ngày bắt đầu thực tế
                    {wch: 18},  // Ngày kết thúc thực tế
                    {wch: 10},  // Tiến độ
                    {wch: 15},  // Trạng thái
                    {wch: 25}   // Ghi chú
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Danh sách công việc');

                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_');
                const filename = `Danh_sach_cong_viec_${timestamp}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);

                hideLoading();
                showToast('Xuất thành công', `Đã xuất ${exportData.length} công việc ra file Excel`, 'success');

            } catch (error) {
                hideLoading();
                console.error('Export error:', error);
                showToast('Lỗi xuất file', 'Có lỗi xảy ra khi xuất file Excel', 'error');
            }
        }

        function downloadTemplate() {
            showLoading('Đang tạo template...');

            try {
                // Create sample template data
                const templateData = [
                    {
                        'STT': 1,
                        'Mã công việc': '', // Will be auto-generated
                        'Team chủ trì': 'Team 1 - Public Cloud Vmware',
                        'Tên sản phẩm/dịch vụ': 'VMware vSphere',
                        'Loại công việc': 'Nhiệm vụ trọng tâm',
                        'Tính chất công việc': 'Sản phẩm mới',
                        'Nhiệm vụ': 'Triển khai VMware vSphere 8.0',
                        'Công việc từng tháng': 'Cài đặt và cấu hình hạ tầng',
                        'Công việc cá nhân tháng': 'Setup ESXi hosts và vCenter',
                        'Mục tiêu': 'Nâng cấp hạ tầng ảo hóa',
                        'DoD (Definition of Done)': 'Hệ thống hoạt động ổn định, pass UAT',
                        'Người phụ trách': 'Nguyễn Văn A',
                        'Team/Người phối hợp': 'Team 2, Team 5',
                        'Ngày bắt đầu kế hoạch': '2025-01-01',
                        'Ngày hoàn thành kế hoạch': '2025-03-31',
                        'Ngày bắt đầu thực tế': '',
                        'Ngày kết thúc thực tế': '',
                        'Tiến độ (%)': 0,
                        'Trạng thái': 'Chưa thực hiện',
                        'Ghi chú': 'Ví dụ mẫu - có thể xóa dòng này'
                    }
                ];

                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(templateData);

                // Set column widths (same as export)
                const colWidths = [
                    {wch: 5}, {wch: 15}, {wch: 30}, {wch: 20},
                    {wch: 18}, {wch: 18}, {wch: 30}, {wch: 30}, {wch: 30},
                    {wch: 25}, {wch: 30}, {wch: 20}, {wch: 25}, {wch: 18},
                    {wch: 18}, {wch: 18}, {wch: 18}, {wch: 10}, {wch: 15}, {wch: 25}
                ];
                ws['!cols'] = colWidths;

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Template');

                // Save template file
                XLSX.writeFile(wb, 'Template_Cong_viec.xlsx');

                hideLoading();
                showToast('Tải template thành công', 'Đã tải template Excel. Điền thông tin và import lại.', 'success');

            } catch (error) {
                hideLoading();
                console.error('Template download error:', error);
                showToast('Lỗi tải template', 'Có lỗi xảy ra khi tạo template', 'error');
            }
        }

        function importTasks() {
            // Check import permission
            if (!canImportTasks()) {
                showToast('Không có quyền', 'Bạn không có quyền import dữ liệu. Chỉ Admin, CPO, PM, PO mới có quyền này.', 'error');
                return;
            }

            // Open Import Wizard
            openImportWizard();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading('Đang xử lý file Excel...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    // Get first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        hideLoading();
                        showToast('File trống', 'File Excel không có dữ liệu để import', 'warning');
                        return;
                    }

                    // Process and validate data
                    processImportData(jsonData);

                } catch (error) {
                    hideLoading();
                    console.error('Import error:', error);
                    showToast('Lỗi đọc file', 'Không thể đọc file Excel. Vui lòng kiểm tra định dạng file.', 'error');
                }
            };

            reader.readAsArrayBuffer(file);

            // Reset file input
            event.target.value = '';
        }

        // Validation lists for dropdown fields
        const VALID_TEAMS = [
            'Team 1 - Public Cloud Vmware',
            'Team 2 - Public Cloud OpenStack',
            'Team 3 - Private Cloud',
            'Team 4 - Backup & DR',
            'Team 5 - Network & Security',
            'Team 6 - DevOps',
            'Team 7 - Monitoring',
            'Team 8 - DB',
            'Team 9 - Middleware',
            'Team 10 - Container',
            'Team 11 - ATM',
            'Team 12 - Core Banking',
            'Team 13 - Digital Banking',
            'Team 14 - Management'
        ];

        const VALID_WORK_TYPES = [
            'Nhiệm vụ trọng tâm',
            'Nhiệm vụ kế hoạch',
            'Nhiệm vụ đột xuất',
            'CTHĐ',
            'TNKH'
        ];

        const VALID_WORK_NATURES = [
            'Sản phẩm mới',
            'Tính năng mới',
            'Nâng cấp',
            'Bảo mật',
            'Quản lý',
            'Nghiên cứu'
        ];

        const VALID_STATUSES = [
            'Chưa thực hiện',
            'Đang thực hiện',
            'Chờ phê duyệt',
            'Hoàn thành'
        ];

        const VALID_ASSIGNEES = [
            'Nguyễn Văn A',
            'Trần Thị B',
            'Lê Văn C',
            'Phạm Thị D',
            'Hoàng Văn E',
            'Nguyễn Thị F',
            'Trần Văn G',
            'Lê Thị H',
            'Trần Văn A'
        ];

        function processImportData(jsonData) {
            const importedTasks = [];
            const errors = [];
            let successCount = 0;

            jsonData.forEach((row, index) => {
                const rowNumber = index + 2; // Excel row number (header is row 1)

                try {
                    // Skip empty rows
                    if (!row['Nhiệm vụ'] && !row['Công việc từng tháng'] && !row['Công việc cá nhân tháng']) {
                        return;
                    }

                    // Check if this is a complete 3-level task (has all 3 columns filled)
                    const hasMainTask = row['Nhiệm vụ'] && row['Nhiệm vụ'].trim();
                    const hasMonthlyWork = row['Công việc từng tháng'] && row['Công việc từng tháng'].trim();
                    const hasPersonalWork = row['Công việc cá nhân tháng'] && row['Công việc cá nhân tháng'].trim();

                    const isComplete3LevelTask = hasMainTask && hasMonthlyWork && hasPersonalWork;

                    // Validate required fields first
                    if (!row['Người phụ trách']) {
                        errors.push(`Dòng ${rowNumber}: Thiếu người phụ trách`);
                        return;
                    }

                    // Parse and validate team information
                    const fullTeam = row['Team chủ trì'] || '';
                    if (!fullTeam) {
                        errors.push(`Dòng ${rowNumber}: Thiếu team chủ trì`);
                        return;
                    }

                    // Validate team value
                    if (!VALID_TEAMS.includes(fullTeam)) {
                        errors.push(`Dòng ${rowNumber}: Team "${fullTeam}" không hợp lệ. Các team hợp lệ: ${VALID_TEAMS.join(', ')}`);
                        return;
                    }

                    // Validate work type
                    const workType = row['Loại công việc'] || '';
                    if (workType && !VALID_WORK_TYPES.includes(workType)) {
                        errors.push(`Dòng ${rowNumber}: Loại công việc "${workType}" không hợp lệ. Các loại hợp lệ: ${VALID_WORK_TYPES.join(', ')}`);
                        return;
                    }

                    // Validate work nature
                    const workNature = row['Tính chất công việc'] || '';
                    if (workNature && !VALID_WORK_NATURES.includes(workNature)) {
                        errors.push(`Dòng ${rowNumber}: Tính chất công việc "${workNature}" không hợp lệ. Các tính chất hợp lệ: ${VALID_WORK_NATURES.join(', ')}`);
                        return;
                    }

                    // Validate status
                    const statusText = row['Trạng thái'] || 'Chưa thực hiện';
                    if (!VALID_STATUSES.includes(statusText)) {
                        errors.push(`Dòng ${rowNumber}: Trạng thái "${statusText}" không hợp lệ. Các trạng thái hợp lệ: ${VALID_STATUSES.join(', ')}`);
                        return;
                    }

                    // Validate assignee
                    const assignee = row['Người phụ trách'];
                    if (!VALID_ASSIGNEES.includes(assignee)) {
                        errors.push(`Dòng ${rowNumber}: Người phụ trách "${assignee}" không hợp lệ. Các người hợp lệ: ${VALID_ASSIGNEES.join(', ')}`);
                        return;
                    }

                    // Now process the task creation
                    if (isComplete3LevelTask) {
                        // Create 3-level task hierarchy
                        const tasksToCreate = create3LevelTaskHierarchy(row, rowNumber, fullTeam, assignee, workType, workNature, statusText);
                        if (tasksToCreate.error) {
                            errors.push(`Dòng ${rowNumber}: ${tasksToCreate.error}`);
                            return;
                        }

                        // Add all 3 tasks to import list
                        importedTasks.push(...tasksToCreate.tasks);
                        successCount += 3; // Count all 3 tasks

                    } else {
                        // Create single task (legacy behavior)
                        const singleTask = createSingleTask(row, rowNumber, fullTeam, assignee, workType, workNature, statusText);
                        if (singleTask.error) {
                            errors.push(`Dòng ${rowNumber}: ${singleTask.error}`);
                            return;
                        }

                        importedTasks.push(singleTask.task);
                        successCount++;
                    }

                    // Additional permission validations
                    if (!canEditTaskForTeam(fullTeam)) {
                        errors.push(`Dòng ${rowNumber}: Bạn không có quyền tạo/sửa công việc cho team "${fullTeam}"`);
                        return;
                    }

                    if (!canAssignToUser(assignee, fullTeam)) {
                        errors.push(`Dòng ${rowNumber}: Bạn không có quyền assign công việc cho "${assignee}" trong team "${fullTeam}"`);
                        return;
                    }

                } catch (error) {
                    errors.push(`Dòng ${rowNumber}: ${error.message}`);
                }
            });

            // Show results
            hideLoading();

            if (errors.length > 0) {
                const errorMessage = `Có ${errors.length} lỗi khi import:\n\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}`;

                // Show detailed error in console for debugging
                console.group('Import Validation Errors:');
                errors.forEach(error => console.error(error));
                console.groupEnd();

                alert(errorMessage);
            }

            if (successCount > 0) {
                // Add imported tasks to main array
                sampleTasks.push(...importedTasks);

                // Refresh table
                filterTasks();

                showToast('Import thành công', `Đã import ${successCount} công việc${errors.length > 0 ? ` (${errors.length} lỗi)` : ''}`, 'success');
            } else {
                showToast('Import thất bại', 'Không có công việc nào được import thành công', 'error');
            }
        }

        function generateWorkCodeForImport(row, level) {
            // Extract team information to generate prefix
            const fullTeam = row['Team chủ trì'] || '';
            const teamMatch = fullTeam.match(/Team (\d+)/);

            if (!teamMatch) {
                // Fallback: use first letters of team name
                const prefix = fullTeam.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 3);
                return `${prefix}${Date.now().toString().slice(-6)}`;
            }

            const teamNumber = parseInt(teamMatch[1]);
            let prefix = '';

            // Map team to prefix based on team structure
            if (teamNumber <= 5) {
                prefix = 'PC' + teamNumber; // IaaS teams
            } else if (teamNumber <= 10) {
                prefix = 'PA' + (teamNumber - 5); // PaaS teams
            } else if (teamNumber <= 13) {
                prefix = 'SW' + (teamNumber - 10); // Software teams
            } else {
                prefix = 'MG1'; // Management team
            }

            // Find next available number for this prefix
            const existingCodes = sampleTasks
                .filter(t => t.code && t.code.startsWith(prefix))
                .map(t => t.code);

            let nextNumber = 1;
            let newCode = '';

            if (level === 'task') {
                // For main tasks: PC1_001
                while (existingCodes.includes(`${prefix}_${String(nextNumber).padStart(3, '0')}`)) {
                    nextNumber++;
                }
                newCode = `${prefix}_${String(nextNumber).padStart(3, '0')}`;
            } else if (level === 'monthly') {
                // For monthly work: PC1_001_001 (need parent task)
                // Find a suitable parent task or create base code
                const baseCode = `${prefix}_001`;
                nextNumber = 1;
                while (existingCodes.includes(`${baseCode}_${String(nextNumber).padStart(3, '0')}`)) {
                    nextNumber++;
                }
                newCode = `${baseCode}_${String(nextNumber).padStart(3, '0')}`;
            } else if (level === 'personal') {
                // For personal work: PC1_001_001_001 (need parent monthly)
                const baseCode = `${prefix}_001_001`;
                nextNumber = 1;
                while (existingCodes.includes(`${baseCode}_${String(nextNumber).padStart(3, '0')}`)) {
                    nextNumber++;
                }
                newCode = `${baseCode}_${String(nextNumber).padStart(3, '0')}`;
            }

            return newCode;
        }

        // Import Wizard Variables
        let wizardData = {
            currentStep: 1,
            fileData: null,
            parsedData: [],
            validData: [],
            errors: [],
            fileName: ''
        };

        // Import Wizard Functions
        function openImportWizard() {
            // Reset wizard state
            wizardData = {
                currentStep: 1,
                fileData: null,
                parsedData: [],
                validData: [],
                errors: [],
                fileName: ''
            };

            // Reset UI
            resetWizardSteps();
            document.getElementById('importWizardModal').classList.add('show');
        }

        function closeImportWizard() {
            document.getElementById('importWizardModal').classList.remove('show');
        }

        function resetWizardSteps() {
            // Reset step indicators
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.getElementById('step1').classList.add('active');

            // Reset step content
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('wizardStep1').classList.add('active');

            // Reset buttons
            document.getElementById('step1NextBtn').disabled = true;
            document.getElementById('wizardFileInput').value = '';
        }

        function nextWizardStep() {
            if (wizardData.currentStep < 4) {
                // Mark current step as completed
                document.getElementById(`step${wizardData.currentStep}`).classList.add('completed');
                document.getElementById(`step${wizardData.currentStep}`).classList.remove('active');

                // Move to next step
                wizardData.currentStep++;

                // Activate next step
                document.getElementById(`step${wizardData.currentStep}`).classList.add('active');

                // Show next step content
                document.querySelectorAll('.wizard-step').forEach(step => {
                    step.classList.remove('active');
                });
                document.getElementById(`wizardStep${wizardData.currentStep}`).classList.add('active');

                // Handle step-specific logic
                if (wizardData.currentStep === 2) {
                    showPreviewData();
                } else if (wizardData.currentStep === 3) {
                    showErrorDetails();
                } else if (wizardData.currentStep === 4) {
                    showImportSummary();
                }
            }
        }

        function prevWizardStep() {
            if (wizardData.currentStep > 1) {
                // Deactivate current step
                document.getElementById(`step${wizardData.currentStep}`).classList.remove('active');
                document.getElementById(`wizardStep${wizardData.currentStep}`).classList.remove('active');

                // Move to previous step
                wizardData.currentStep--;

                // Activate previous step
                document.getElementById(`step${wizardData.currentStep}`).classList.add('active');
                document.getElementById(`step${wizardData.currentStep}`).classList.remove('completed');
                document.getElementById(`wizardStep${wizardData.currentStep}`).classList.add('active');
            }
        }

        function handleWizardFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            wizardData.fileName = file.name;

            // Show loading
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #00458b; margin-bottom: 16px;"></i>
                <p>Đang đọc file: ${file.name}</p>
                <p style="font-size: 14px; color: #666;">Vui lòng đợi...</p>
            `;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    // Get first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    wizardData.parsedData = jsonData;

                    // Show success
                    uploadArea.innerHTML = `
                        <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745; margin-bottom: 16px;"></i>
                        <p><strong>${file.name}</strong> đã được tải lên thành công</p>
                        <p style="font-size: 14px; color: #666;">Tìm thấy ${jsonData.length} dòng dữ liệu</p>
                    `;

                    // Enable next button
                    document.getElementById('step1NextBtn').disabled = false;

                } catch (error) {
                    console.error('File read error:', error);
                    uploadArea.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 16px;"></i>
                        <p>Lỗi đọc file: ${file.name}</p>
                        <p style="font-size: 14px; color: #dc3545;">Vui lòng kiểm tra định dạng file Excel</p>
                    `;
                    document.getElementById('step1NextBtn').disabled = true;
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function showPreviewData() {
            const data = wizardData.parsedData;

            // Validate data and separate valid/invalid
            const { validData, errors } = validateImportData(data);
            wizardData.validData = validData;
            wizardData.errors = errors;

            // Show summary
            const summaryDiv = document.getElementById('previewSummary');
            summaryDiv.innerHTML = `
                <h4 style="color: #333; margin-bottom: 20px;">📊 Tổng quan dữ liệu</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-number">${data.length}</div>
                        <div class="stat-label">Tổng dòng</div>
                    </div>
                    <div class="stat-item success">
                        <div class="stat-number">${validData.length}</div>
                        <div class="stat-label">Hợp lệ</div>
                    </div>
                    <div class="stat-item error">
                        <div class="stat-number">${errors.length}</div>
                        <div class="stat-label">Có lỗi</div>
                    </div>
                </div>
            `;

            // Show preview table (first 10 rows)
            const previewDiv = document.getElementById('previewTable');
            if (data.length > 0) {
                const headers = Object.keys(data[0]);
                const previewRows = data.slice(0, 10);

                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                ${headers.map(h => `<th>${h}</th>`).join('')}
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                previewRows.forEach((row, index) => {
                    const hasError = errors.some(e => e.rowNumber === index + 2);
                    const rowClass = hasError ? 'error-row' : 'valid-row';

                    tableHTML += `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            ${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}
                            <td>${hasError ? '❌ Có lỗi' : '✅ Hợp lệ'}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                if (data.length > 10) {
                    tableHTML += `<p style="text-align: center; margin-top: 10px; color: #666;">... và ${data.length - 10} dòng khác</p>`;
                }

                previewDiv.innerHTML = tableHTML;
            }

            // Update next button
            const nextBtn = document.getElementById('step2NextBtn');
            if (errors.length > 0) {
                nextBtn.innerHTML = `Sửa lỗi (${errors.length}) <i class="fas fa-arrow-right"></i>`;
            } else {
                nextBtn.innerHTML = `Tiếp theo <i class="fas fa-arrow-right"></i>`;
            }
        }

        function validateImportData(jsonData) {
            const validData = [];
            const errors = [];

            jsonData.forEach((row, index) => {
                const rowNumber = index + 2; // Excel row number
                const rowErrors = [];

                try {
                    // Skip empty rows
                    if (!row['Nhiệm vụ'] && !row['Công việc từng tháng'] && !row['Công việc cá nhân tháng']) {
                        return;
                    }

                    // Validate required fields
                    if (!row['Người phụ trách']) {
                        rowErrors.push('Thiếu người phụ trách');
                    }

                    const fullTeam = row['Team chủ trì'] || '';
                    if (!fullTeam) {
                        rowErrors.push('Thiếu team chủ trì');
                    }

                    // Validate dropdown values
                    if (fullTeam && !VALID_TEAMS.includes(fullTeam)) {
                        rowErrors.push(`Team "${fullTeam}" không hợp lệ`);
                    }

                    const workType = row['Loại công việc'] || '';
                    if (workType && !VALID_WORK_TYPES.includes(workType)) {
                        rowErrors.push(`Loại công việc "${workType}" không hợp lệ`);
                    }

                    const workNature = row['Tính chất công việc'] || '';
                    if (workNature && !VALID_WORK_NATURES.includes(workNature)) {
                        rowErrors.push(`Tính chất công việc "${workNature}" không hợp lệ`);
                    }

                    const statusText = row['Trạng thái'] || 'Chưa thực hiện';
                    if (!VALID_STATUSES.includes(statusText)) {
                        rowErrors.push(`Trạng thái "${statusText}" không hợp lệ`);
                    }

                    const assignee = row['Người phụ trách'];
                    if (assignee && !VALID_ASSIGNEES.includes(assignee)) {
                        rowErrors.push(`Người phụ trách "${assignee}" không hợp lệ`);
                    }

                    // Permission validations
                    if (fullTeam && !canEditTaskForTeam(fullTeam)) {
                        rowErrors.push(`Không có quyền tạo công việc cho team "${fullTeam}"`);
                    }

                    if (assignee && fullTeam && !canAssignToUser(assignee, fullTeam)) {
                        rowErrors.push(`Không có quyền assign cho "${assignee}" trong team "${fullTeam}"`);
                    }

                    if (rowErrors.length === 0) {
                        validData.push({ ...row, rowNumber });
                    } else {
                        errors.push({
                            rowNumber,
                            data: row,
                            errors: rowErrors
                        });
                    }

                } catch (error) {
                    errors.push({
                        rowNumber,
                        data: row,
                        errors: [error.message]
                    });
                }
            });

            return { validData, errors };
        }

        function showErrorDetails() {
            const errors = wizardData.errors;

            // Show error summary
            const summaryDiv = document.getElementById('errorSummary');
            if (errors.length === 0) {
                summaryDiv.innerHTML = `
                    <div class="success-summary">
                        <h4>🎉 Tuyệt vời! Không có lỗi nào</h4>
                        <p>Tất cả ${wizardData.validData.length} dòng dữ liệu đều hợp lệ và sẵn sàng import.</p>
                    </div>
                `;
                document.getElementById('step3NextBtn').disabled = false;
                document.getElementById('step3NextBtn').innerHTML = `Tiếp theo <i class="fas fa-arrow-right"></i>`;
            } else {
                summaryDiv.innerHTML = `
                    <div class="error-summary">
                        <h4>⚠️ Tìm thấy ${errors.length} lỗi cần sửa</h4>
                        <p>Dữ liệu Excel của bạn có một số lỗi cần được khắc phục trước khi import.</p>
                        <p><strong>Bạn có 3 lựa chọn:</strong></p>
                    </div>

                    <div class="instruction-box">
                        <h5>📝 Hướng dẫn xử lý lỗi:</h5>
                        <ol>
                            <li><strong>Sửa file Excel gốc:</strong>
                                <ul style="margin-top: 5px; padding-left: 15px;">
                                    <li>Tải lại file Excel gốc về máy</li>
                                    <li>Sửa các lỗi theo danh sách bên dưới</li>
                                    <li>Lưu file và quay lại Bước 1 để upload lại</li>
                                </ul>
                            </li>
                            <li><strong>Bỏ qua lỗi:</strong> Chỉ import ${wizardData.validData.length} dòng hợp lệ, bỏ qua ${errors.length} dòng có lỗi</li>
                            <li><strong>Hủy import:</strong> Quay lại để chuẩn bị dữ liệu tốt hơn</li>
                        </ol>
                    </div>
                `;
                document.getElementById('step3NextBtn').disabled = true;

                // Show download original file button
                document.getElementById('downloadOriginalBtn').style.display = 'inline-block';
            }

            // Show error details
            const detailsDiv = document.getElementById('errorDetails');
            if (errors.length > 0) {
                let errorHTML = '';
                errors.forEach(error => {
                    errorHTML += `
                        <div class="error-item">
                            <div class="error-row">Dòng ${error.rowNumber}</div>
                            <div class="error-message">
                                ${error.errors.map(e => `• ${e}`).join('<br>')}
                            </div>
                        </div>
                    `;
                });
                detailsDiv.innerHTML = errorHTML;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function downloadOriginalFile() {
            try {
                // Create Excel file from original parsed data
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(wizardData.parsedData);

                // Set column widths
                const colWidths = [
                    {wch: 5}, {wch: 15}, {wch: 30}, {wch: 20},
                    {wch: 18}, {wch: 18}, {wch: 30}, {wch: 30}, {wch: 30},
                    {wch: 25}, {wch: 30}, {wch: 20}, {wch: 25}, {wch: 12},
                    {wch: 12}, {wch: 10}, {wch: 15}, {wch: 25}
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Data');

                // Generate filename
                const originalName = wizardData.fileName.replace(/\.[^/.]+$/, ""); // Remove extension
                const filename = `${originalName}_CanSua.xlsx`;

                XLSX.writeFile(wb, filename);

                showToast('Tải thành công', `Đã tải file "${filename}". Sửa lỗi và upload lại ở Bước 1.`, 'info');

            } catch (error) {
                console.error('Download error:', error);
                showToast('Lỗi tải file', 'Không thể tải file gốc. Vui lòng thử lại.', 'error');
            }
        }

        function skipErrors() {
            // Allow proceeding with only valid data
            document.getElementById('step3NextBtn').disabled = false;
            document.getElementById('step3NextBtn').innerHTML = `Import ${wizardData.validData.length} dòng hợp lệ <i class="fas fa-arrow-right"></i>`;

            showToast('Bỏ qua lỗi', `Sẽ import ${wizardData.validData.length} dòng hợp lệ, bỏ qua ${wizardData.errors.length} dòng có lỗi`, 'warning');
        }

        function showImportSummary() {
            const validCount = wizardData.validData.length;
            const errorCount = wizardData.errors.length;
            const totalCount = validCount + errorCount;

            // Calculate 3-level tasks
            const complete3LevelTasks = wizardData.validData.filter(row =>
                row['Nhiệm vụ'] && row['Công việc từng tháng'] && row['Công việc cá nhân tháng']
            ).length;

            const singleTasks = validCount - complete3LevelTasks;
            const totalTasksToCreate = (complete3LevelTasks * 3) + singleTasks;

            const summaryDiv = document.getElementById('importSummary');
            summaryDiv.innerHTML = `
                <h4 style="color: #333; margin-bottom: 20px;">🚀 Sẵn sàng import dữ liệu</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-number">${totalCount}</div>
                        <div class="stat-label">Tổng dòng Excel</div>
                    </div>
                    <div class="stat-item success">
                        <div class="stat-number">${validCount}</div>
                        <div class="stat-label">Dòng hợp lệ</div>
                    </div>
                    <div class="stat-item info">
                        <div class="stat-number">${totalTasksToCreate}</div>
                        <div class="stat-label">Tasks sẽ tạo</div>
                    </div>
                    ${errorCount > 0 ? `
                    <div class="stat-item error">
                        <div class="stat-number">${errorCount}</div>
                        <div class="stat-label">Dòng bỏ qua</div>
                    </div>
                    ` : ''}
                </div>

                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                    <h5>Chi tiết import:</h5>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${complete3LevelTasks > 0 ? `<li><strong>${complete3LevelTasks}</strong> task đầy đủ 3 cấp → tạo <strong>${complete3LevelTasks * 3}</strong> records</li>` : ''}
                        ${singleTasks > 0 ? `<li><strong>${singleTasks}</strong> task đơn lẻ → tạo <strong>${singleTasks}</strong> records</li>` : ''}
                        <li>File: <strong>${wizardData.fileName}</strong></li>
                        <li>Thời gian: <strong>${new Date().toLocaleString('vi-VN')}</strong></li>
                    </ul>
                </div>

                <p style="color: #666; font-style: italic;">
                    Nhấn "Import ngay" để bắt đầu quá trình import. Quá trình này không thể hoàn tác.
                </p>
            `;
        }

        function executeImport() {
            const validData = wizardData.validData;

            if (validData.length === 0) {
                showToast('Không có dữ liệu', 'Không có dữ liệu hợp lệ để import', 'warning');
                return;
            }

            // Show loading
            document.getElementById('finalImportBtn').innerHTML = `
                <i class="fas fa-spinner fa-spin"></i> Đang import...
            `;
            document.getElementById('finalImportBtn').disabled = true;

            // Execute import with delay for UX
            setTimeout(() => {
                try {
                    const importedTasks = [];
                    let successCount = 0;

                    validData.forEach(row => {
                        const hasMainTask = row['Nhiệm vụ'] && row['Nhiệm vụ'].trim();
                        const hasMonthlyWork = row['Công việc từng tháng'] && row['Công việc từng tháng'].trim();
                        const hasPersonalWork = row['Công việc cá nhân tháng'] && row['Công việc cá nhân tháng'].trim();

                        const isComplete3LevelTask = hasMainTask && hasMonthlyWork && hasPersonalWork;

                        if (isComplete3LevelTask) {
                            const result = create3LevelTaskHierarchy(row, row.rowNumber, row['Team chủ trì'], row['Người phụ trách'],
                                row['Loại công việc'], row['Tính chất công việc'], row['Trạng thái'] || 'Chưa thực hiện');
                            if (result.tasks) {
                                importedTasks.push(...result.tasks);
                                successCount += 3;
                            }
                        } else {
                            const result = createSingleTask(row, row.rowNumber, row['Team chủ trì'], row['Người phụ trách'],
                                row['Loại công việc'], row['Tính chất công việc'], row['Trạng thái'] || 'Chưa thực hiện');
                            if (result.task) {
                                importedTasks.push(result.task);
                                successCount++;
                            }
                        }
                    });

                    // Add to main tasks array
                    sampleTasks.push(...importedTasks);

                    // Refresh table
                    filterTasks();

                    // Close wizard
                    closeImportWizard();

                    // Show success
                    showToast('Import thành công', `Đã import thành công ${successCount} công việc từ ${wizardData.fileName}`, 'success');

                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Lỗi import', 'Có lỗi xảy ra khi import dữ liệu', 'error');

                    // Reset button
                    document.getElementById('finalImportBtn').innerHTML = `
                        <i class="fas fa-upload"></i> Import ngay
                    `;
                    document.getElementById('finalImportBtn').disabled = false;
                }
            }, 1500);
        }

        function create3LevelTaskHierarchy(row, rowNumber, fullTeam, assignee, workType, workNature, statusText) {
            try {
                const baseId = Math.max(...sampleTasks.map(t => t.id), 0) + 1;
                const tasks = [];

                // Parse common data
                const statusMap = {
                    'Chưa thực hiện': 'not-started',
                    'Đang thực hiện': 'in-progress',
                    'Chờ phê duyệt': 'pending-approval',
                    'Hoàn thành': 'completed'
                };
                const status = statusMap[statusText] || 'not-started';
                let progress = parseInt(row['Tiến độ (%)']) || 0;
                if (progress < 0) progress = 0;
                if (progress > 100) progress = 100;

                // Generate work codes for 3 levels
                const taskCode = generateWorkCodeForImport(row, 'task');
                const monthlyCode = `${taskCode}_001`;
                const personalCode = `${monthlyCode}_001`;

                // 1. Create main task
                const mainTask = {
                    id: baseId,
                    code: taskCode,
                    title: row['Nhiệm vụ'],
                    monthlyWork: '',
                    personalWork: '',
                    level: 'task',
                    team: fullTeam,
                    type: workType || 'Nhiệm vụ kế hoạch',
                    nature: workNature || '',
                    product: row['Tên sản phẩm/dịch vụ'] || '',
                    objective: row['Mục tiêu'] || '',
                    dod: row['DoD (Definition of Done)'] || '',
                    assignee: assignee,
                    collaborators: row['Team/Người phối hợp'] ? row['Team/Người phối hợp'].split(',').map(s => s.trim()) : [],
                    plannedStartDate: row['Ngày bắt đầu kế hoạch'] || '',
                    plannedEndDate: row['Ngày hoàn thành kế hoạch'] || '',
                    actualStartDate: row['Ngày bắt đầu thực tế'] || '',
                    actualEndDate: row['Ngày kết thúc thực tế'] || '',
                    startDate: row['Ngày bắt đầu kế hoạch'] || '', // Legacy compatibility
                    dueDate: row['Ngày hoàn thành kế hoạch'] || '', // Legacy compatibility
                    progress: Math.round(progress * 0.6), // Main task gets 60% of total progress
                    status: progress === 100 ? 'completed' : (progress > 0 ? 'in-progress' : 'not-started'),
                    notes: row['Ghi chú'] || '',
                    selected: false
                };

                // 2. Create monthly task
                const monthlyTask = {
                    id: baseId + 1,
                    code: monthlyCode,
                    title: row['Nhiệm vụ'], // Inherit from main task
                    monthlyWork: row['Công việc từng tháng'],
                    personalWork: '',
                    level: 'monthly',
                    team: fullTeam,
                    type: workType || 'Nhiệm vụ kế hoạch',
                    nature: workNature || '',
                    product: row['Tên sản phẩm/dịch vụ'] || '',
                    objective: row['Mục tiêu'] || '',
                    dod: row['DoD (Definition of Done)'] || '',
                    assignee: assignee,
                    collaborators: row['Team/Người phối hợp'] ? row['Team/Người phối hợp'].split(',').map(s => s.trim()) : [],
                    plannedStartDate: row['Ngày bắt đầu kế hoạch'] || '',
                    plannedEndDate: row['Ngày hoàn thành kế hoạch'] || '',
                    actualStartDate: row['Ngày bắt đầu thực tế'] || '',
                    actualEndDate: row['Ngày kết thúc thực tế'] || '',
                    startDate: row['Ngày bắt đầu kế hoạch'] || '', // Legacy compatibility
                    dueDate: row['Ngày hoàn thành kế hoạch'] || '', // Legacy compatibility
                    progress: Math.round(progress * 0.8), // Monthly task gets 80% of total progress
                    status: progress === 100 ? 'pending-approval' : (progress > 0 ? 'in-progress' : 'not-started'),
                    notes: row['Ghi chú'] || '',
                    selected: false
                };

                // 3. Create personal task
                const personalTask = {
                    id: baseId + 2,
                    code: personalCode,
                    title: row['Nhiệm vụ'], // Inherit from main task
                    monthlyWork: row['Công việc từng tháng'],
                    personalWork: row['Công việc cá nhân tháng'],
                    level: 'personal',
                    team: fullTeam,
                    type: workType || 'Nhiệm vụ kế hoạch',
                    nature: workNature || '',
                    product: row['Tên sản phẩm/dịch vụ'] || '',
                    objective: row['Mục tiêu'] || '',
                    dod: row['DoD (Definition of Done)'] || '',
                    assignee: assignee,
                    collaborators: row['Team/Người phối hợp'] ? row['Team/Người phối hợp'].split(',').map(s => s.trim()) : [],
                    plannedStartDate: row['Ngày bắt đầu kế hoạch'] || '',
                    plannedEndDate: row['Ngày hoàn thành kế hoạch'] || '',
                    actualStartDate: row['Ngày bắt đầu thực tế'] || '',
                    actualEndDate: row['Ngày kết thúc thực tế'] || '',
                    startDate: row['Ngày bắt đầu kế hoạch'] || '', // Legacy compatibility
                    dueDate: row['Ngày hoàn thành kế hoạch'] || '', // Legacy compatibility
                    progress: progress, // Personal task gets full progress
                    status: status,
                    notes: row['Ghi chú'] || '',
                    selected: false
                };

                tasks.push(mainTask, monthlyTask, personalTask);
                return { tasks: tasks };

            } catch (error) {
                return { error: error.message };
            }
        }

        function createSingleTask(row, rowNumber, fullTeam, assignee, workType, workNature, statusText) {
            try {
                // Determine task level and content
                let level = 'task';
                let title = '';
                let monthlyWork = '';
                let personalWork = '';

                if (row['Nhiệm vụ']) {
                    level = 'task';
                    title = row['Nhiệm vụ'];
                } else if (row['Công việc từng tháng']) {
                    level = 'monthly';
                    title = row['Công việc từng tháng'];
                    monthlyWork = row['Công việc từng tháng'];
                } else if (row['Công việc cá nhân tháng']) {
                    level = 'personal';
                    title = row['Công việc cá nhân tháng'];
                    personalWork = row['Công việc cá nhân tháng'];
                }

                if (!title) {
                    return { error: 'Thiếu tên công việc' };
                }

                // Parse status and progress
                const statusMap = {
                    'Chưa thực hiện': 'not-started',
                    'Đang thực hiện': 'in-progress',
                    'Chờ phê duyệt': 'pending-approval',
                    'Hoàn thành': 'completed'
                };
                const status = statusMap[statusText] || 'not-started';
                let progress = parseInt(row['Tiến độ (%)']) || 0;
                if (progress < 0) progress = 0;
                if (progress > 100) progress = 100;

                // Generate work code
                let workCode = row['Mã công việc'] || '';
                if (!workCode) {
                    workCode = generateWorkCodeForImport(row, level);
                }

                const newTask = {
                    id: Math.max(...sampleTasks.map(t => t.id), 0) + 1,
                    code: workCode,
                    title: title,
                    monthlyWork: monthlyWork,
                    personalWork: personalWork,
                    level: level,
                    team: fullTeam,
                    type: workType || 'Nhiệm vụ kế hoạch',
                    nature: workNature || '',
                    product: row['Tên sản phẩm/dịch vụ'] || '',
                    objective: row['Mục tiêu'] || '',
                    dod: row['DoD (Definition of Done)'] || '',
                    assignee: assignee,
                    collaborators: row['Team/Người phối hợp'] ? row['Team/Người phối hợp'].split(',').map(s => s.trim()) : [],
                    plannedStartDate: row['Ngày bắt đầu kế hoạch'] || '',
                    plannedEndDate: row['Ngày hoàn thành kế hoạch'] || '',
                    actualStartDate: row['Ngày bắt đầu thực tế'] || '',
                    actualEndDate: row['Ngày kết thúc thực tế'] || '',
                    startDate: row['Ngày bắt đầu kế hoạch'] || '', // Legacy compatibility
                    dueDate: row['Ngày hoàn thành kế hoạch'] || '', // Legacy compatibility
                    progress: progress,
                    status: status,
                    notes: row['Ghi chú'] || '',
                    selected: false
                };

                return { task: newTask };

            } catch (error) {
                return { error: error.message };
            }
        }



        function bulkDelete() {
            const selectedTasks = sampleTasks.filter(task => task.selected);
            if (selectedTasks.length === 0) {
                alert('Vui lòng chọn ít nhất một công việc để xóa');
                return;
            }

            // Create detailed confirmation message
            let confirmMessage = `Bạn có chắc chắn muốn xóa ${selectedTasks.length} công việc đã chọn?\n\n`;
            confirmMessage += 'Danh sách công việc sẽ bị xóa:\n';

            selectedTasks.slice(0, 5).forEach((task, index) => {
                confirmMessage += `${index + 1}. ${task.code} - ${task.title}\n`;
            });

            if (selectedTasks.length > 5) {
                confirmMessage += `... và ${selectedTasks.length - 5} công việc khác\n`;
            }

            confirmMessage += '\nHành động này không thể hoàn tác!';

            if (confirm(confirmMessage)) {
                showLoading('Đang xóa công việc...');

                // Simulate async operation
                setTimeout(() => {
                    // Remove selected tasks from sampleTasks array
                    const selectedIds = selectedTasks.map(task => task.id);
                    for (let i = sampleTasks.length - 1; i >= 0; i--) {
                        if (selectedIds.includes(sampleTasks[i].id)) {
                            sampleTasks.splice(i, 1);
                        }
                    }

                    // Refresh the table
                    filterTasks();
                    updateBulkActions();

                    hideLoading();

                    // Show success message
                    showToast('Xóa thành công', `Đã xóa ${selectedTasks.length} công việc`, 'success');
                }, 800);
            }
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Submenu toggle
        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.submenu-arrow');

            if (submenu.style.display === 'block') {
                submenu.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
                element.classList.remove('expanded');
            } else {
                submenu.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
                element.classList.add('expanded');
            }
        }

        // Menu item click handlers
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') {
                    e.preventDefault();
                }
                
                // Remove active class from all items
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));

                // Add active class to clicked item
                this.classList.add('active');
            });
        });
    </script>

    <!-- Import Wizard Modal -->
    <div id="importWizardModal" class="modal">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
                <h2>🧙‍♂️ Import Wizard - Nhập dữ liệu Excel</h2>
                <span class="close" onclick="closeImportWizard()">&times;</span>
            </div>

            <!-- Progress Steps -->
            <div class="wizard-steps">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-title">Upload File</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-title">Preview Data</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-title">Fix Errors</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-title">Import</div>
                </div>
            </div>

            <!-- Step 1: Upload File -->
            <div id="wizardStep1" class="wizard-step active">
                <h3>📁 Bước 1: Chọn file Excel để import</h3>
                <div class="upload-area" onclick="document.getElementById('wizardFileInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                    <p>Click để chọn file Excel hoặc kéo thả file vào đây</p>
                    <p style="font-size: 14px; color: #666;">Hỗ trợ: .xlsx, .xls</p>
                </div>
                <input type="file" id="wizardFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleWizardFileUpload(event)">

                <div class="wizard-actions">
                    <button class="btn" onclick="downloadTemplate()">
                        <i class="fas fa-download"></i> Tải Template
                    </button>
                    <button class="btn btn-primary" id="step1NextBtn" onclick="nextWizardStep()" disabled>
                        Tiếp theo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Preview Data -->
            <div id="wizardStep2" class="wizard-step">
                <h3>👀 Bước 2: Xem trước dữ liệu</h3>
                <div id="previewSummary" class="preview-summary"></div>
                <div id="previewTable" class="preview-table"></div>

                <div class="wizard-actions">
                    <button class="btn" onclick="prevWizardStep()">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                    <button class="btn btn-primary" id="step2NextBtn" onclick="nextWizardStep()">
                        Tiếp theo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Fix Errors -->
            <div id="wizardStep3" class="wizard-step">
                <h3>🔧 Bước 3: Sửa lỗi dữ liệu</h3>
                <div id="errorSummary" class="error-summary"></div>
                <div id="errorDetails" class="error-details"></div>

                <div class="wizard-actions">
                    <button class="btn" onclick="prevWizardStep()">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                    <button class="btn" onclick="downloadOriginalFile()" id="downloadOriginalBtn" style="display: none;">
                        <i class="fas fa-download"></i> Tải file gốc
                    </button>
                    <button class="btn" onclick="skipErrors()">
                        <i class="fas fa-exclamation-triangle"></i> Bỏ qua lỗi
                    </button>
                    <button class="btn btn-primary" id="step3NextBtn" onclick="nextWizardStep()" disabled>
                        Tiếp theo <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Import -->
            <div id="wizardStep4" class="wizard-step">
                <h3>🚀 Bước 4: Xác nhận và Import</h3>
                <div id="importSummary" class="import-summary"></div>

                <div class="wizard-actions">
                    <button class="btn" onclick="prevWizardStep()">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                    <button class="btn btn-primary" id="finalImportBtn" onclick="executeImport()">
                        <i class="fas fa-upload"></i> Import ngay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Thêm công việc mới</h2>
                <button class="modal-close" onclick="closeTaskModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Form Progress Indicator -->
                <div class="form-progress">
                    <div class="form-progress-title">Tiến độ hoàn thành form</div>
                    <div class="form-progress-bar">
                        <div class="form-progress-fill" id="formProgressFill" style="width: 20%;"></div>
                    </div>
                    <div class="form-progress-text" id="formProgressText">2/10 trường bắt buộc đã điền</div>
                </div>

                <form id="taskForm">
                    <!-- 📋 Basic Information Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleFormSection('basicInfo')">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-info-circle"></i>
                                <span>Thông tin cơ bản</span>
                                <span class="form-section-description">Cấp độ, tên công việc, team</span>
                            </div>
                            <i class="form-section-toggle fas fa-chevron-down" id="basicInfo-toggle"></i>
                        </div>
                        <div class="form-section-content expanded" id="basicInfo-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskLevel" class="required">Cấp độ</label>
                                    <select id="taskLevel" class="form-control" required onchange="updateFormFields(); updateFormProgress();">
                                        <option value="">Chọn cấp độ</option>
                                        <option value="task">Nhiệm vụ</option>
                                        <option value="monthly">Công việc từng tháng</option>
                                        <option value="personal">Công việc cá nhân tháng</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskTitle" class="required">Tên nhiệm vụ</label>
                                    <input type="text" id="taskTitle" class="form-control" placeholder="Nhập tên nhiệm vụ" required oninput="updateFormProgress()">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskTeam" class="required">Team chủ trì</label>
                                    <select id="taskTeam" class="form-control" required onchange="updateProductOptions(); updateFormProgress();">
                                        <option value="">Chọn team</option>
                                        <option value="Team 1 - Public Cloud Vmware">Team 1 - Public Cloud Vmware</option>
                                        <option value="Team 2 - Public Cloud OpenStack">Team 2 - Public Cloud OpenStack</option>
                                        <option value="Team 3 - Private Cloud">Team 3 - Private Cloud</option>
                                        <option value="Team 4 - Backup & DR">Team 4 - Backup & DR</option>
                                        <option value="Team 5 - Network & Security">Team 5 - Network & Security</option>
                                        <option value="Team 6 - DevOps">Team 6 - DevOps</option>
                                        <option value="Team 7 - Monitoring">Team 7 - Monitoring</option>
                                        <option value="Team 8 - DB">Team 8 - DB</option>
                                        <option value="Team 9 - Middleware">Team 9 - Middleware</option>
                                        <option value="Team 10 - Container">Team 10 - Container</option>
                                        <option value="Team 11 - Web Development">Team 11 - Web Development</option>
                                        <option value="Team 12 - Mobile Development">Team 12 - Mobile Development</option>
                                        <option value="Team 13 - AI/ML">Team 13 - AI/ML</option>
                                        <option value="Team 14 - Management">Team 14 - Management</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskProduct">Tên sản phẩm/dịch vụ</label>
                                    <select id="taskProduct" class="form-control">
                                        <option value="">Chọn sản phẩm/dịch vụ</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Parent Task Row (hiện khi chọn monthly/personal) -->
                            <div class="form-row full-width" id="parentTaskRow" style="display: none;">
                                <div class="form-group">
                                    <label for="taskParent" class="required">Công việc cha</label>
                                    <select id="taskParent" class="form-control" required onchange="onParentTaskChange(); updateFormProgress();">
                                        <option value="">Chọn công việc cha</option>
                                    </select>
                                    <small class="form-text text-muted" id="parentTaskHelp">
                                        Chọn nhiệm vụ cha để tạo công việc con
                                    </small>
                                    <small class="form-text text-success" id="userTeamInfo">
                                        <!-- Team info will be populated by JavaScript -->
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 🔗 Hierarchy & Work Details Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleFormSection('workDetails')">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-list-alt"></i>
                                <span>Chi tiết công việc</span>
                                <span class="form-section-description">Mục tiêu, DoD, công việc tháng/cá nhân</span>
                            </div>
                            <i class="form-section-toggle fas fa-chevron-down" id="workDetails-toggle"></i>
                        </div>
                        <div class="form-section-content expanded" id="workDetails-content">
                            <div class="form-row full-width">
                                <div class="form-group">
                                    <label for="taskObjective">Mục tiêu</label>
                                    <textarea id="taskObjective" class="form-control" rows="2" placeholder="Mô tả mục tiêu của công việc"></textarea>
                                </div>
                            </div>

                            <div class="form-row full-width">
                                <div class="form-group">
                                    <label for="taskDoD" class="required">DoD (Definition of Done)</label>
                                    <textarea id="taskDoD" class="form-control" rows="3" placeholder="Tiêu chí hoàn thành công việc" required oninput="updateFormProgress()"></textarea>
                                </div>
                            </div>

                            <!-- Monthly/Personal Work Fields (hiện khi chọn monthly/personal) -->
                            <div id="monthlyWorkRow" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="monthlyWork">Công việc từng tháng</label>
                                        <textarea id="monthlyWork" class="form-control" rows="2" placeholder="Mô tả công việc từng tháng" oninput="updateFormProgress()"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="personalWork">Công việc cá nhân tháng</label>
                                        <textarea id="personalWork" class="form-control" rows="2" placeholder="Mô tả công việc cá nhân tháng" oninput="updateFormProgress()"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 👥 Assignment & Collaboration Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleFormSection('assignment')">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-user"></i>
                                <span>Phân công & Phối hợp</span>
                                <span class="form-section-description">Người phụ trách, team phối hợp</span>
                            </div>
                            <i class="form-section-toggle fas fa-chevron-down" id="assignment-toggle"></i>
                        </div>
                        <div class="form-section-content expanded" id="assignment-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskAssignee" class="required">Người phụ trách</label>
                                    <select id="taskAssignee" class="form-control" required onchange="updateFormProgress()">
                                        <option value="">Chọn người phụ trách</option>
                                        <option value="Nguyễn Văn A">Nguyễn Văn A</option>
                                        <option value="Trần Văn B">Trần Văn B</option>
                                        <option value="Lê Thị C">Lê Thị C</option>
                                        <option value="Phạm Văn D">Phạm Văn D</option>
                                        <option value="Hoàng Thị E">Hoàng Thị E</option>
                                        <option value="Vũ Văn F">Vũ Văn F</option>
                                        <option value="Đặng Thị G">Đặng Thị G</option>
                                        <option value="Bùi Văn H">Bùi Văn H</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskCollaborators">Team/Người phối hợp</label>
                                    <select id="taskCollaborators" class="form-control" multiple>
                                        <option value="Team 1 - Public Cloud Vmware">Team 1 - Public Cloud Vmware</option>
                                        <option value="Team 2 - Public Cloud OpenStack">Team 2 - Public Cloud OpenStack</option>
                                        <option value="Team 3 - Private Cloud">Team 3 - Private Cloud</option>
                                        <option value="Team 4 - Backup & DR">Team 4 - Backup & DR</option>
                                        <option value="Team 5 - Network & Security">Team 5 - Network & Security</option>
                                        <option value="Team 6 - DevOps">Team 6 - DevOps</option>
                                        <option value="Team 7 - Monitoring">Team 7 - Monitoring</option>
                                        <option value="Team 8 - DB">Team 8 - DB</option>
                                        <option value="Team 9 - Middleware">Team 9 - Middleware</option>
                                        <option value="Team 10 - Container">Team 10 - Container</option>
                                        <option value="Team 11 - Web Development">Team 11 - Web Development</option>
                                        <option value="Team 12 - Mobile Development">Team 12 - Mobile Development</option>
                                        <option value="Team 13 - AI/ML">Team 13 - AI/ML</option>
                                        <option value="Team 14 - Management">Team 14 - Management</option>
                                    </select>
                                    <small class="form-text text-muted">Giữ Ctrl để chọn nhiều team</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 📅 Schedule & Dates Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleFormSection('schedule')">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-calendar-alt"></i>
                                <span>Lịch trình & Thời gian</span>
                                <span class="form-section-description">Ngày kế hoạch, ngày thực tế</span>
                            </div>
                            <i class="form-section-toggle fas fa-chevron-down" id="schedule-toggle"></i>
                        </div>
                        <div class="form-section-content expanded" id="schedule-content">
                            <!-- Ngày kế hoạch -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskPlannedStart" class="required">Ngày bắt đầu kế hoạch</label>
                                    <input type="date" id="taskPlannedStart" class="form-control" required onchange="updateFormProgress()">
                                </div>
                                <div class="form-group">
                                    <label for="taskPlannedEnd" class="required">Ngày hoàn thành kế hoạch</label>
                                    <input type="date" id="taskPlannedEnd" class="form-control" required onchange="updateFormProgress()">
                                </div>
                            </div>

                            <!-- Ngày thực tế -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskActualStart">Ngày bắt đầu thực tế</label>
                                    <input type="date" id="taskActualStart" class="form-control">
                                    <small class="form-text text-muted" id="actualStartHelp">
                                        Với công việc cha, ngày này được tự động tính từ các công việc con
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label for="taskActualEnd">Ngày kết thúc thực tế</label>
                                    <input type="date" id="taskActualEnd" class="form-control">
                                    <small class="form-text text-muted" id="actualEndHelp">
                                        Với công việc cha, ngày này được tự động tính từ các công việc con
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 📊 Progress & Status Section -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleFormSection('progress')">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-chart-bar"></i>
                                <span>Tiến độ & Trạng thái</span>
                                <span class="form-section-description">Phần trăm hoàn thành, trạng thái, ghi chú</span>
                            </div>
                            <i class="form-section-toggle fas fa-chevron-down" id="progress-toggle"></i>
                        </div>
                        <div class="form-section-content expanded" id="progress-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskProgress">Tiến độ (%)</label>
                                    <input type="number" id="taskProgress" class="form-control" min="0" max="100" value="0">
                                    <small class="form-text text-muted" id="progressHelp">
                                        Nhập phần trăm hoàn thành (0-100%)
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label for="taskStatus">Trạng thái</label>
                                    <select id="taskStatus" class="form-control">
                                        <option value="not-started">Chưa thực hiện</option>
                                        <option value="in-progress">Đang thực hiện</option>
                                        <option value="pending-approval">Chờ phê duyệt</option>
                                        <option value="completed">Hoàn thành</option>
                                    </select>
                                    <small class="form-text text-muted" id="statusHelp">
                                        Trạng thái sẽ tự động cập nhật dựa trên tiến độ
                                    </small>
                                </div>
                            </div>

                            <div class="form-row full-width">
                                <div class="form-group">
                                    <label for="taskNote">Ghi chú/Điều chỉnh</label>
                                    <textarea id="taskNote" class="form-control" rows="3" placeholder="Ghi chú về tiến độ, vấn đề, điều chỉnh..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ⚙️ Advanced Settings Section (Collapsed by default) -->
                    <div class="form-section">
                        <div class="form-section-header" onclick="toggleFormSection('advanced')">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-cog"></i>
                                <span>Cài đặt nâng cao</span>
                                <span class="form-section-description">Loại công việc, tính chất, mã công việc</span>
                            </div>
                            <i class="form-section-toggle fas fa-chevron-down collapsed" id="advanced-toggle"></i>
                        </div>
                        <div class="form-section-content collapsed" id="advanced-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskType">Loại công việc</label>
                                    <select id="taskType" class="form-control">
                                        <option value="">Chọn loại công việc</option>
                                        <option value="Nhiệm vụ trọng tâm">Nhiệm vụ trọng tâm</option>
                                        <option value="Nhiệm vụ kế hoạch">Nhiệm vụ kế hoạch</option>
                                        <option value="CTHĐ">CTHĐ</option>
                                        <option value="TNKH">TNKH</option>
                                        <option value="NetBI">NetBI</option>
                                        <option value="Đầu tư">Đầu tư</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskNature">Tính chất công việc</label>
                                    <select id="taskNature" class="form-control">
                                        <option value="">Chọn tính chất</option>
                                        <option value="Sản phẩm mới">Sản phẩm mới</option>
                                        <option value="Tính năng mới">Tính năng mới</option>
                                        <option value="Cải tiến">Cải tiến</option>
                                        <option value="Bảo trì">Bảo trì</option>
                                        <option value="Hỗ trợ">Hỗ trợ</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskCode">Mã công việc</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="taskCode" class="form-control" placeholder="Sẽ được tự động tạo" readonly>
                                        <button type="button" class="btn btn-outline-primary" onclick="generateTaskCode()" style="white-space: nowrap;">
                                            <i class="fas fa-magic"></i> Tạo mã
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        Mã công việc sẽ được tự động tạo dựa trên team và cấp độ
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 🔐 Approval Section (Hidden by default, shown for tasks needing approval) -->
                    <div class="form-section" id="approvalSection" style="display: none;">
                        <div class="form-section-header">
                            <div class="form-section-title">
                                <i class="form-section-icon far fa-check-circle"></i>
                                <span>Phê duyệt công việc</span>
                                <span class="form-section-description">Xem xét và phê duyệt công việc hoàn thành</span>
                            </div>
                        </div>
                        <div class="form-section-content expanded">
                            <div class="form-row full-width">
                                <div class="form-group">
                                    <div style="background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 20px;">
                                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                            <i class="fas fa-exclamation-triangle" style="color: #ff9500; margin-right: 8px;"></i>
                                            <span style="color: #ff9500; font-weight: 600;">Công việc này đang chờ phê duyệt</span>
                                        </div>
                                        <div id="approvalInfo" style="color: #ccc; margin-bottom: 20px; line-height: 1.5;">
                                            <!-- Thông tin phê duyệt sẽ được điền bằng JavaScript -->
                                        </div>
                                        <div style="display: flex; gap: 12px;">
                                            <button type="button" class="btn btn-primary" onclick="approveTaskInForm()" style="background: #00ff88; border-color: #00ff88;">
                                                <i class="fas fa-check"></i> Phê duyệt
                                            </button>
                                            <button type="button" class="btn" onclick="rejectTaskInForm()" style="background: #ff4d4f; border-color: #ff4d4f; color: #fff;">
                                                <i class="fas fa-times"></i> Không phê duyệt
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeTaskModal()">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Đang xử lý...</div>
        </div>
    </div>
</body>
</html>
